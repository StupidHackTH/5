(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[724],{9446:function(e,t,n){"use strict";var r=n(6099),i=n(909),o=n(4589),a=n(655),s=n(4594);e=n.hmd(e);var u=n(4155),l="";function c(e){l=e}var h=function(){function e(e){this.domStorage_=e,this.prefix_="firebase:"}return e.prototype.set=function(e,t){null==t?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),(0,o.stringify)(t))},e.prototype.get=function(e){var t=this.domStorage_.getItem(this.prefixedName_(e));return null==t?null:(0,o.jsonEval)(t)},e.prototype.remove=function(e){this.domStorage_.removeItem(this.prefixedName_(e))},e.prototype.prefixedName_=function(e){return this.prefix_+e},e.prototype.toString=function(){return this.domStorage_.toString()},e}(),d=function(){function e(){this.cache_={},this.isInMemoryStorage=!0}return e.prototype.set=function(e,t){null==t?delete this.cache_[e]:this.cache_[e]=t},e.prototype.get=function(e){return(0,o.contains)(this.cache_,e)?this.cache_[e]:null},e.prototype.remove=function(e){delete this.cache_[e]},e}(),p=function(e){try{if("undefined"!==typeof window&&"undefined"!==typeof window[e]){var t=window[e];return t.setItem("firebase:sentinel","cache"),t.removeItem("firebase:sentinel"),new h(t)}}catch(n){}return new d},f=p("localStorage"),_=p("sessionStorage"),v=new s.Logger("@firebase/database"),y=function(){var e=1;return function(){return e++}}(),g=function(e){var t=(0,o.stringToByteArray)(e),n=new o.Sha1;n.update(t);var r=n.digest();return o.base64.encodeByteArray(r)},m=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n="",r=0;r<e.length;r++){var i=e[r];Array.isArray(i)||i&&"object"===typeof i&&"number"===typeof i.length?n+=m.apply(null,i):n+="object"===typeof i?(0,o.stringify)(i):i,n+=" "}return n},C=null,w=!0,b=function(e,t){(0,o.assert)(!t||!0===e||!1===e,"Can't turn on custom loggers persistently."),!0===e?(v.logLevel=s.LogLevel.VERBOSE,C=v.log.bind(v),t&&_.set("logging_enabled",!0)):"function"===typeof e?C=e:(C=null,_.remove("logging_enabled"))},T=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!0===w&&(w=!1,null===C&&!0===_.get("logging_enabled")&&b(!0)),C){var n=m.apply(null,e);C(n)}},k=function(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];T.apply(void 0,(0,a.__spreadArray)([e],(0,a.__read)(t)))}},I=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n="FIREBASE INTERNAL ERROR: "+m.apply(void 0,(0,a.__spreadArray)([],(0,a.__read)(e)));v.error(n)},E=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n="FIREBASE FATAL ERROR: "+m.apply(void 0,(0,a.__spreadArray)([],(0,a.__read)(e)));throw v.error(n),new Error(n)},S=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n="FIREBASE WARNING: "+m.apply(void 0,(0,a.__spreadArray)([],(0,a.__read)(e)));v.warn(n)},P=function(e){return"number"===typeof e&&(e!==e||e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY)},x="[MIN_NAME]",N="[MAX_NAME]",R=function(e,t){if(e===t)return 0;if(e===x||t===N)return-1;if(t===x||e===N)return 1;var n=j(e),r=j(t);return null!==n?null!==r?n-r===0?e.length-t.length:n-r:-1:null!==r?1:e<t?-1:1},A=function(e,t){return e===t?0:e<t?-1:1},D=function(e,t){if(t&&e in t)return t[e];throw new Error("Missing required key ("+e+") in object: "+(0,o.stringify)(t))},O=function(e){if("object"!==typeof e||null===e)return(0,o.stringify)(e);var t=[];for(var n in e)t.push(n);t.sort();for(var r="{",i=0;i<t.length;i++)0!==i&&(r+=","),r+=(0,o.stringify)(t[i]),r+=":",r+=O(e[t[i]]);return r+="}"},M=function(e,t){var n=e.length;if(n<=t)return[e];for(var r=[],i=0;i<n;i+=t)i+t>n?r.push(e.substring(i,n)):r.push(e.substring(i,i+t));return r};function q(e,t){for(var n in e)e.hasOwnProperty(n)&&t(n,e[n])}var F=function(e){(0,o.assert)(!P(e),"Invalid JSON number");var t,n,r,i,a,s=1023;0===e?(n=0,r=0,t=1/e===-1/0?1:0):(t=e<0,(e=Math.abs(e))>=Math.pow(2,-1022)?(n=(i=Math.min(Math.floor(Math.log(e)/Math.LN2),s))+s,r=Math.round(e*Math.pow(2,52-i)-Math.pow(2,52))):(n=0,r=Math.round(e/Math.pow(2,-1074))));var u=[];for(a=52;a;a-=1)u.push(r%2?1:0),r=Math.floor(r/2);for(a=11;a;a-=1)u.push(n%2?1:0),n=Math.floor(n/2);u.push(t?1:0),u.reverse();var l=u.join(""),c="";for(a=0;a<64;a+=8){var h=parseInt(l.substr(a,8),2).toString(16);1===h.length&&(h="0"+h),c+=h}return c.toLowerCase()};var L=new RegExp("^-?(0*)\\d{1,10}$"),W=-2147483648,U=2147483647,j=function(e){if(L.test(e)){var t=Number(e);if(t>=W&&t<=U)return t}return null},B=function(e){try{e()}catch(t){setTimeout((function(){var e=t.stack||"";throw S("Exception was thrown by user callback.",e),t}),Math.floor(0))}},V=function(e,t){var n=setTimeout(e,t);return"object"===typeof n&&n.unref&&n.unref(),n},Q=function(){function e(e,t){var n=this;this.appName_=e,this.appCheckProvider=t,this.appCheck=null===t||void 0===t?void 0:t.getImmediate({optional:!0}),this.appCheck||null===t||void 0===t||t.get().then((function(e){return n.appCheck=e}))}return e.prototype.getToken=function(e){var t=this;return this.appCheck?this.appCheck.getToken(e):new Promise((function(n,r){setTimeout((function(){t.appCheck?t.getToken(e).then(n,r):n(null)}),0)}))},e.prototype.addTokenChangeListener=function(e){var t;null===(t=this.appCheckProvider)||void 0===t||t.get().then((function(t){return t.addTokenListener(e)}))},e.prototype.notifyForInvalidToken=function(){S('Provided AppCheck credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly.')},e}(),H=function(){function e(e,t,n){var r=this;this.appName_=e,this.firebaseOptions_=t,this.authProvider_=n,this.auth_=null,this.auth_=n.getImmediate({optional:!0}),this.auth_||n.onInit((function(e){return r.auth_=e}))}return e.prototype.getToken=function(e){var t=this;return this.auth_?this.auth_.getToken(e).catch((function(e){return e&&"auth/token-not-initialized"===e.code?(T("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(e)})):new Promise((function(n,r){setTimeout((function(){t.auth_?t.getToken(e).then(n,r):n(null)}),0)}))},e.prototype.addTokenChangeListener=function(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then((function(t){return t.addAuthTokenListener(e)}))},e.prototype.removeTokenChangeListener=function(e){this.authProvider_.get().then((function(t){return t.removeAuthTokenListener(e)}))},e.prototype.notifyForInvalidToken=function(){var e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',S(e)},e}(),z=function(){function e(e){this.accessToken=e}return e.prototype.getToken=function(e){return Promise.resolve({accessToken:this.accessToken})},e.prototype.addTokenChangeListener=function(e){e(this.accessToken)},e.prototype.removeTokenChangeListener=function(e){},e.prototype.notifyForInvalidToken=function(){},e.OWNER="owner",e}(),Y="5",K=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,G="websocket",$="long_polling",J=function(){function e(e,t,n,r,i,o,a){void 0===i&&(i=!1),void 0===o&&(o=""),void 0===a&&(a=!1),this.secure=t,this.namespace=n,this.webSocketOnly=r,this.nodeAdmin=i,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=f.get("host:"+e)||this._host}return e.prototype.isCacheableHost=function(){return"s-"===this.internalHost.substr(0,2)},e.prototype.isCustomHost=function(){return"firebaseio.com"!==this._domain&&"firebaseio-demo.com"!==this._domain},Object.defineProperty(e.prototype,"host",{get:function(){return this._host},set:function(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&f.set("host:"+this._host,this.internalHost))},enumerable:!1,configurable:!0}),e.prototype.toString=function(){var e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e},e.prototype.toURLString=function(){var e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?"?ns="+this.namespace:"";return""+e+this.host+"/"+t},e}();function X(e,t,n){var r;if((0,o.assert)("string"===typeof t,"typeof type must == string"),(0,o.assert)("object"===typeof n,"typeof params must == object"),t===G)r=(e.secure?"wss://":"ws://")+e.internalHost+"/.ws?";else{if(t!==$)throw new Error("Unknown connection type: "+t);r=(e.secure?"https://":"http://")+e.internalHost+"/.lp?"}(function(e){return e.host!==e.internalHost||e.isCustomHost()||e.includeNamespaceInQueryParams})(e)&&(n.ns=e.namespace);var i=[];return q(n,(function(e,t){i.push(e+"="+t)})),r+i.join("&")}var Z=function(){function e(){this.counters_={}}return e.prototype.incrementCounter=function(e,t){void 0===t&&(t=1),(0,o.contains)(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t},e.prototype.get=function(){return(0,o.deepCopy)(this.counters_)},e}(),ee={},te={};function ne(e){var t=e.toString();return ee[t]||(ee[t]=new Z),ee[t]}var re=function(){function e(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}return e.prototype.closeAfter=function(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)},e.prototype.handleResponse=function(e,t){var n=this;this.pendingResponses[e]=t;for(var r=function(){var e=i.pendingResponses[i.currentResponseNum];delete i.pendingResponses[i.currentResponseNum];for(var t=function(t){e[t]&&B((function(){n.onMessage_(e[t])}))},r=0;r<e.length;++r)t(r);if(i.currentResponseNum===i.closeAfterResponse)return i.onClose&&(i.onClose(),i.onClose=null),"break";i.currentResponseNum++},i=this;this.pendingResponses[this.currentResponseNum];){if("break"===r())break}},e}(),ie="start",oe="close",ae=function(){function e(e,t,n,r,i,o,a){var s=this;this.connId=e,this.repoInfo=t,this.applicationId=n,this.appCheckToken=r,this.authToken=i,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=k(e),this.stats_=ne(t),this.urlFn=function(e){return s.appCheckToken&&(e.ac=s.appCheckToken),X(t,$,e)}}return e.prototype.open=function(e,t){var n=this;this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new re(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout((function(){n.log_("Timed out trying to connect."),n.onClosed_(),n.connectTimeoutTimer_=null}),Math.floor(3e4)),function(e){if((0,o.isNodeSdk)()||"complete"===document.readyState)e();else{var t=!1,n=function(){document.body?t||(t=!0,e()):setTimeout(n,Math.floor(10))};document.addEventListener?(document.addEventListener("DOMContentLoaded",n,!1),window.addEventListener("load",n,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",(function(){"complete"===document.readyState&&n()})),window.attachEvent("onload",n))}}((function(){if(!n.isClosed_){n.scriptTagHolder=new se((function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=(0,a.__read)(e,5),i=r[0],o=r[1],s=r[2];if(r[3],r[4],n.incrementIncomingBytes_(e),n.scriptTagHolder)if(n.connectTimeoutTimer_&&(clearTimeout(n.connectTimeoutTimer_),n.connectTimeoutTimer_=null),n.everConnected_=!0,i===ie)n.id=o,n.password=s;else{if(i!==oe)throw new Error("Unrecognized command received: "+i);o?(n.scriptTagHolder.sendNewPolls=!1,n.myPacketOrderer.closeAfter(o,(function(){n.onClosed_()}))):n.onClosed_()}}),(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=(0,a.__read)(e,2),i=r[0],o=r[1];n.incrementIncomingBytes_(e),n.myPacketOrderer.handleResponse(i,o)}),(function(){n.onClosed_()}),n.urlFn);var e={start:"t"};e.ser=Math.floor(1e8*Math.random()),n.scriptTagHolder.uniqueCallbackIdentifier&&(e.cb=n.scriptTagHolder.uniqueCallbackIdentifier),e.v=Y,n.transportSessionId&&(e.s=n.transportSessionId),n.lastSessionId&&(e.ls=n.lastSessionId),n.applicationId&&(e.p=n.applicationId),n.appCheckToken&&(e.ac=n.appCheckToken),"undefined"!==typeof location&&location.hostname&&K.test(location.hostname)&&(e.r="f");var t=n.urlFn(e);n.log_("Connecting via long-poll to "+t),n.scriptTagHolder.addTag(t,(function(){}))}}))},e.prototype.start=function(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)},e.forceAllow=function(){e.forceAllow_=!0},e.forceDisallow=function(){e.forceDisallow_=!0},e.isAvailable=function(){return!(0,o.isNodeSdk)()&&(!!e.forceAllow_||!e.forceDisallow_&&"undefined"!==typeof document&&null!=document.createElement&&!("object"===typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))&&!("object"===typeof Windows&&"object"===typeof Windows.UI))},e.prototype.markConnectionHealthy=function(){},e.prototype.shutdown_=function(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)},e.prototype.onClosed_=function(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))},e.prototype.close=function(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())},e.prototype.send=function(e){var t=(0,o.stringify)(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);for(var n=(0,o.base64Encode)(t),r=M(n,1840),i=0;i<r.length;i++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,r.length,r[i]),this.curSegmentNum++},e.prototype.addDisconnectPingFrame=function(e,t){if(!(0,o.isNodeSdk)()){this.myDisconnFrame=document.createElement("iframe");var n={dframe:"t"};n.id=e,n.pw=t,this.myDisconnFrame.src=this.urlFn(n),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}},e.prototype.incrementIncomingBytes_=function(e){var t=(0,o.stringify)(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)},e}(),se=function(){function e(t,n,r,i){if(this.onDisconnect=r,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,(0,o.isNodeSdk)())this.commandCB=t,this.onMessageCB=n;else{this.uniqueCallbackIdentifier=y(),window["pLPCommand"+this.uniqueCallbackIdentifier]=t,window["pRTLPCB"+this.uniqueCallbackIdentifier]=n,this.myIFrame=e.createIFrame_();var a="";if(this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,"javascript:".length))a='<script>document.domain="'+document.domain+'";<\/script>';var s="<html><body>"+a+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(s),this.myIFrame.doc.close()}catch(u){T("frame writing exception"),u.stack&&T(u.stack),T(u)}}}return e.createIFrame_=function(){var e=document.createElement("iframe");if(e.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(e);try{e.contentWindow.document||T("No IE domain setting required")}catch(n){var t=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+t+"';document.close();})())"}return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e},e.prototype.close=function(){var e=this;this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.innerHTML="",setTimeout((function(){null!==e.myIFrame&&(document.body.removeChild(e.myIFrame),e.myIFrame=null)}),Math.floor(0)));var t=this.onDisconnect;t&&(this.onDisconnect=null,t())},e.prototype.startLongPoll=function(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););},e.prototype.newRequest_=function(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;var e={};e.id=this.myID,e.pw=this.myPW,e.ser=this.currentSerial;for(var t=this.urlFn(e),n="",r=0;this.pendingSegs.length>0;){if(!(this.pendingSegs[0].d.length+30+n.length<=1870))break;var i=this.pendingSegs.shift();n=n+"&seg"+r+"="+i.seg+"&ts"+r+"="+i.ts+"&d"+r+"="+i.d,r++}return t+=n,this.addLongPollTag_(t,this.currentSerial),!0}return!1},e.prototype.enqueueSegment=function(e,t,n){this.pendingSegs.push({seg:e,ts:t,d:n}),this.alive&&this.newRequest_()},e.prototype.addLongPollTag_=function(e,t){var n=this;this.outstandingRequests.add(t);var r=function(){n.outstandingRequests.delete(t),n.newRequest_()},i=setTimeout(r,Math.floor(25e3));this.addTag(e,(function(){clearTimeout(i),r()}))},e.prototype.addTag=function(e,t){var n=this;(0,o.isNodeSdk)()?this.doNodeLongPoll(e,t):setTimeout((function(){try{if(!n.sendNewPolls)return;var r=n.myIFrame.doc.createElement("script");r.type="text/javascript",r.async=!0,r.src=e,r.onload=r.onreadystatechange=function(){var e=r.readyState;e&&"loaded"!==e&&"complete"!==e||(r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),t())},r.onerror=function(){T("Long-poll script failed to load: "+e),n.sendNewPolls=!1,n.close()},n.myIFrame.doc.body.appendChild(r)}catch(i){}}),Math.floor(1))},e}(),ue=null;"undefined"!==typeof MozWebSocket?ue=MozWebSocket:"undefined"!==typeof WebSocket&&(ue=WebSocket);var le=function(){function e(t,n,r,i,o,a,s){this.connId=t,this.applicationId=r,this.appCheckToken=i,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=k(this.connId),this.stats_=ne(n),this.connURL=e.connectionURL_(n,a,s,i),this.nodeAdmin=n.nodeAdmin}return e.connectionURL_=function(e,t,n,r){var i={};return i.v=Y,!(0,o.isNodeSdk)()&&"undefined"!==typeof location&&location.hostname&&K.test(location.hostname)&&(i.r="f"),t&&(i.s=t),n&&(i.ls=n),r&&(i.ac=r),X(e,G,i)},e.prototype.open=function(e,t){var n=this;this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,f.set("previous_websocket_failure",!0);try{if((0,o.isNodeSdk)()){var r=this.nodeAdmin?"AdminNode":"Node",i={headers:{"User-Agent":"Firebase/5/"+l+"/"+u.platform+"/"+r,"X-Firebase-GMPID":this.applicationId||""}};this.authToken&&(i.headers.Authorization="Bearer "+this.authToken),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);var a=u.env,s=0===this.connURL.indexOf("wss://")?a.HTTPS_PROXY||a.https_proxy:a.HTTP_PROXY||a.http_proxy;s&&(i.proxy={origin:s}),this.mySock=new ue(this.connURL,[],i)}else{i={headers:{"X-Firebase-GMPID":this.applicationId||"","X-Firebase-AppCheck":this.appCheckToken||""}};this.mySock=new ue(this.connURL,[],i)}}catch(h){this.log_("Error instantiating WebSocket.");var c=h.message||h.data;return c&&this.log_(c),void this.onClosed_()}this.mySock.onopen=function(){n.log_("Websocket connected."),n.everConnected_=!0},this.mySock.onclose=function(){n.log_("Websocket connection was disconnected."),n.mySock=null,n.onClosed_()},this.mySock.onmessage=function(e){n.handleIncomingFrame(e)},this.mySock.onerror=function(e){n.log_("WebSocket error.  Closing connection.");var t=e.message||e.data;t&&n.log_(t),n.onClosed_()}},e.prototype.start=function(){},e.forceDisallow=function(){e.forceDisallow_=!0},e.isAvailable=function(){var t=!1;if("undefined"!==typeof navigator&&navigator.userAgent){var n=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);n&&n.length>1&&parseFloat(n[1])<4.4&&(t=!0)}return!t&&null!==ue&&!e.forceDisallow_},e.previouslyFailed=function(){return f.isInMemoryStorage||!0===f.get("previous_websocket_failure")},e.prototype.markConnectionHealthy=function(){f.remove("previous_websocket_failure")},e.prototype.appendFrame_=function(e){if(this.frames.push(e),this.frames.length===this.totalFrames){var t=this.frames.join("");this.frames=null;var n=(0,o.jsonEval)(t);this.onMessage(n)}},e.prototype.handleNewFrameCount_=function(e){this.totalFrames=e,this.frames=[]},e.prototype.extractFrameCount_=function(e){if((0,o.assert)(null===this.frames,"We already have a frame buffer"),e.length<=6){var t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e},e.prototype.handleIncomingFrame=function(e){if(null!==this.mySock){var t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(t);else{var n=this.extractFrameCount_(t);null!==n&&this.appendFrame_(n)}}},e.prototype.send=function(e){this.resetKeepAlive();var t=(0,o.stringify)(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);var n=M(t,16384);n.length>1&&this.sendString_(String(n.length));for(var r=0;r<n.length;r++)this.sendString_(n[r])},e.prototype.shutdown_=function(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)},e.prototype.onClosed_=function(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))},e.prototype.close=function(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())},e.prototype.resetKeepAlive=function(){var e=this;clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval((function(){e.mySock&&e.sendString_("0"),e.resetKeepAlive()}),Math.floor(45e3))},e.prototype.sendString_=function(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}},e.responsesRequiredToBeHealthy=2,e.healthyTimeout=3e4,e}(),ce=function(){function e(e){this.initTransports_(e)}return Object.defineProperty(e,"ALL_TRANSPORTS",{get:function(){return[ae,le]},enumerable:!1,configurable:!0}),e.prototype.initTransports_=function(t){var n,r,i=le&&le.isAvailable(),o=i&&!le.previouslyFailed();if(t.webSocketOnly&&(i||S("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),o=!0),o)this.transports_=[le];else{var s=this.transports_=[];try{for(var u=(0,a.__values)(e.ALL_TRANSPORTS),l=u.next();!l.done;l=u.next()){var c=l.value;c&&c.isAvailable()&&s.push(c)}}catch(h){n={error:h}}finally{try{l&&!l.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}}},e.prototype.initialTransport=function(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")},e.prototype.upgradeTransport=function(){return this.transports_.length>1?this.transports_[1]:null},e}(),he=function(){function e(e,t,n,r,i,o,a,s,u,l){this.id=e,this.repoInfo_=t,this.applicationId_=n,this.appCheckToken_=r,this.authToken_=i,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=s,this.onKill_=u,this.lastSessionId=l,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=k("c:"+this.id+":"),this.transportManager_=new ce(t),this.log_("Connection created"),this.start_()}return e.prototype.start_=function(){var e=this,t=this.transportManager_.initialTransport();this.conn_=new t(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=t.responsesRequiredToBeHealthy||0;var n=this.connReceiver_(this.conn_),r=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout((function(){e.conn_&&e.conn_.open(n,r)}),Math.floor(0));var i=t.healthyTimeout||0;i>0&&(this.healthyTimeout_=V((function(){e.healthyTimeout_=null,e.isHealthy_||(e.conn_&&e.conn_.bytesReceived>102400?(e.log_("Connection exceeded healthy timeout but has received "+e.conn_.bytesReceived+" bytes.  Marking connection healthy."),e.isHealthy_=!0,e.conn_.markConnectionHealthy()):e.conn_&&e.conn_.bytesSent>10240?e.log_("Connection exceeded healthy timeout but has sent "+e.conn_.bytesSent+" bytes.  Leaving connection alive."):(e.log_("Closing unhealthy connection after timeout."),e.close()))}),Math.floor(i)))},e.prototype.nextTransportId_=function(){return"c:"+this.id+":"+this.connectionCount++},e.prototype.disconnReceiver_=function(e){var t=this;return function(n){e===t.conn_?t.onConnectionLost_(n):e===t.secondaryConn_?(t.log_("Secondary connection lost."),t.onSecondaryConnectionLost_()):t.log_("closing an old connection")}},e.prototype.connReceiver_=function(e){var t=this;return function(n){2!==t.state_&&(e===t.rx_?t.onPrimaryMessageReceived_(n):e===t.secondaryConn_?t.onSecondaryMessageReceived_(n):t.log_("message on old connection"))}},e.prototype.sendRequest=function(e){var t={t:"d",d:e};this.sendData_(t)},e.prototype.tryCleanupConnection=function(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)},e.prototype.onSecondaryControl_=function(e){if("t"in e){var t=e.t;"a"===t?this.upgradeIfSecondaryHealthy_():"r"===t?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),this.tx_!==this.secondaryConn_&&this.rx_!==this.secondaryConn_||this.close()):"o"===t&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}},e.prototype.onSecondaryMessageReceived_=function(e){var t=D("t",e),n=D("d",e);if("c"===t)this.onSecondaryControl_(n);else{if("d"!==t)throw new Error("Unknown protocol layer: "+t);this.pendingDataMessages.push(n)}},e.prototype.upgradeIfSecondaryHealthy_=function(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))},e.prototype.proceedWithUpgrade_=function(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()},e.prototype.onPrimaryMessageReceived_=function(e){var t=D("t",e),n=D("d",e);"c"===t?this.onControl_(n):"d"===t&&this.onDataMessage_(n)},e.prototype.onDataMessage_=function(e){this.onPrimaryResponse_(),this.onMessage_(e)},e.prototype.onPrimaryResponse_=function(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))},e.prototype.onControl_=function(e){var t=D("t",e);if("d"in e){var n=e.d;if("h"===t)this.onHandshake_(n);else if("n"===t){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(var r=0;r<this.pendingDataMessages.length;++r)this.onDataMessage_(this.pendingDataMessages[r]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===t?this.onConnectionShutdown_(n):"r"===t?this.onReset_(n):"e"===t?I("Server Error: "+n):"o"===t?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):I("Unknown control packet command: "+t)}},e.prototype.onHandshake_=function(e){var t=e.ts,n=e.v,r=e.h;this.sessionId=e.s,this.repoInfo_.host=r,0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Y!==n&&S("Protocol version mismatch detected"),this.tryStartUpgrade_())},e.prototype.tryStartUpgrade_=function(){var e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)},e.prototype.startUpgrade_=function(e){var t=this;this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;var n=this.connReceiver_(this.secondaryConn_),r=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(n,r),V((function(){t.secondaryConn_&&(t.log_("Timed out trying to upgrade."),t.secondaryConn_.close())}),Math.floor(6e4))},e.prototype.onReset_=function(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,1===this.state_?this.close():(this.closeConnections_(),this.start_())},e.prototype.onConnectionEstablished_=function(e,t){var n=this;this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):V((function(){n.sendPingOnPrimaryIfNecessary_()}),Math.floor(5e3))},e.prototype.sendPingOnPrimaryIfNecessary_=function(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))},e.prototype.onSecondaryConnectionLost_=function(){var e=this.secondaryConn_;this.secondaryConn_=null,this.tx_!==e&&this.rx_!==e||this.close()},e.prototype.onConnectionLost_=function(e){this.conn_=null,e||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(f.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()},e.prototype.onConnectionShutdown_=function(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()},e.prototype.sendData_=function(e){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(e)},e.prototype.close=function(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))},e.prototype.closeConnections_=function(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)},e}(),de=function(){function e(){}return e.prototype.put=function(e,t,n,r){},e.prototype.merge=function(e,t,n,r){},e.prototype.refreshAuthToken=function(e){},e.prototype.refreshAppCheckToken=function(e){},e.prototype.onDisconnectPut=function(e,t,n){},e.prototype.onDisconnectMerge=function(e,t,n){},e.prototype.onDisconnectCancel=function(e,t){},e.prototype.reportStats=function(e){},e}(),pe=function(){function e(e){this.allowedEvents_=e,this.listeners_={},(0,o.assert)(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}return e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(Array.isArray(this.listeners_[e]))for(var r=(0,a.__spreadArray)([],(0,a.__read)(this.listeners_[e])),i=0;i<r.length;i++)r[i].callback.apply(r[i].context,t)},e.prototype.on=function(e,t,n){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:n});var r=this.getInitialEvent(e);r&&t.apply(n,r)},e.prototype.off=function(e,t,n){this.validateEventType_(e);for(var r=this.listeners_[e]||[],i=0;i<r.length;i++)if(r[i].callback===t&&(!n||n===r[i].context))return void r.splice(i,1)},e.prototype.validateEventType_=function(e){(0,o.assert)(this.allowedEvents_.find((function(t){return t===e})),"Unknown event: "+e)},e}(),fe=function(e){function t(){var t=e.call(this,["online"])||this;return t.online_=!0,"undefined"===typeof window||"undefined"===typeof window.addEventListener||(0,o.isMobileCordova)()||(window.addEventListener("online",(function(){t.online_||(t.online_=!0,t.trigger("online",!0))}),!1),window.addEventListener("offline",(function(){t.online_&&(t.online_=!1,t.trigger("online",!1))}),!1)),t}return(0,a.__extends)(t,e),t.getInstance=function(){return new t},t.prototype.getInitialEvent=function(e){return(0,o.assert)("online"===e,"Unknown event type: "+e),[this.online_]},t.prototype.currentlyOnline=function(){return this.online_},t}(pe),_e=function(){function e(e,t){if(void 0===t){this.pieces_=e.split("/");for(var n=0,r=0;r<this.pieces_.length;r++)this.pieces_[r].length>0&&(this.pieces_[n]=this.pieces_[r],n++);this.pieces_.length=n,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}return e.prototype.toString=function(){for(var e="",t=this.pieceNum_;t<this.pieces_.length;t++)""!==this.pieces_[t]&&(e+="/"+this.pieces_[t]);return e||"/"},e}();function ve(){return new _e("")}function ye(e){return e.pieceNum_>=e.pieces_.length?null:e.pieces_[e.pieceNum_]}function ge(e){return e.pieces_.length-e.pieceNum_}function me(e){var t=e.pieceNum_;return t<e.pieces_.length&&t++,new _e(e.pieces_,t)}function Ce(e){return e.pieceNum_<e.pieces_.length?e.pieces_[e.pieces_.length-1]:null}function we(e,t){return void 0===t&&(t=0),e.pieces_.slice(e.pieceNum_+t)}function be(e){if(e.pieceNum_>=e.pieces_.length)return null;for(var t=[],n=e.pieceNum_;n<e.pieces_.length-1;n++)t.push(e.pieces_[n]);return new _e(t,0)}function Te(e,t){for(var n=[],r=e.pieceNum_;r<e.pieces_.length;r++)n.push(e.pieces_[r]);if(t instanceof _e)for(r=t.pieceNum_;r<t.pieces_.length;r++)n.push(t.pieces_[r]);else{var i=t.split("/");for(r=0;r<i.length;r++)i[r].length>0&&n.push(i[r])}return new _e(n,0)}function ke(e){return e.pieceNum_>=e.pieces_.length}function Ie(e,t){var n=ye(e),r=ye(t);if(null===n)return t;if(n===r)return Ie(me(e),me(t));throw new Error("INTERNAL ERROR: innerPath ("+t+") is not within outerPath ("+e+")")}function Ee(e,t){for(var n=we(e,0),r=we(t,0),i=0;i<n.length&&i<r.length;i++){var o=R(n[i],r[i]);if(0!==o)return o}return n.length===r.length?0:n.length<r.length?-1:1}function Se(e,t){if(ge(e)!==ge(t))return!1;for(var n=e.pieceNum_,r=t.pieceNum_;n<=e.pieces_.length;n++,r++)if(e.pieces_[n]!==t.pieces_[r])return!1;return!0}function Pe(e,t){var n=e.pieceNum_,r=t.pieceNum_;if(ge(e)>ge(t))return!1;for(;n<e.pieces_.length;){if(e.pieces_[n]!==t.pieces_[r])return!1;++n,++r}return!0}var xe=function(e,t){this.errorPrefix_=t,this.parts_=we(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(var n=0;n<this.parts_.length;n++)this.byteLength_+=(0,o.stringLength)(this.parts_[n]);Ne(this)};function Ne(e){if(e.byteLength_>768)throw new Error(e.errorPrefix_+"has a key path longer than 768 bytes ("+e.byteLength_+").");if(e.parts_.length>32)throw new Error(e.errorPrefix_+"path specified exceeds the maximum depth that can be written (32) or object contains a cycle "+Re(e))}function Re(e){return 0===e.parts_.length?"":"in property '"+e.parts_.join(".")+"'"}var Ae,De,Oe=function(e){function t(){var t,n,r=e.call(this,["visible"])||this;return"undefined"!==typeof document&&"undefined"!==typeof document.addEventListener&&("undefined"!==typeof document.hidden?(n="visibilitychange",t="hidden"):"undefined"!==typeof document.mozHidden?(n="mozvisibilitychange",t="mozHidden"):"undefined"!==typeof document.msHidden?(n="msvisibilitychange",t="msHidden"):"undefined"!==typeof document.webkitHidden&&(n="webkitvisibilitychange",t="webkitHidden")),r.visible_=!0,n&&document.addEventListener(n,(function(){var e=!document[t];e!==r.visible_&&(r.visible_=e,r.trigger("visible",e))}),!1),r}return(0,a.__extends)(t,e),t.getInstance=function(){return new t},t.prototype.getInitialEvent=function(e){return(0,o.assert)("visible"===e,"Unknown event type: "+e),[this.visible_]},t}(pe),Me=1e3,qe=function(e){function t(n,r,i,a,s,u,l,c){var h=e.call(this)||this;if(h.repoInfo_=n,h.applicationId_=r,h.onDataUpdate_=i,h.onConnectStatus_=a,h.onServerInfoUpdate_=s,h.authTokenProvider_=u,h.appCheckTokenProvider_=l,h.authOverride_=c,h.id=t.nextPersistentConnectionId_++,h.log_=k("p:"+h.id+":"),h.interruptReasons_={},h.listens=new Map,h.outstandingPuts_=[],h.outstandingGets_=[],h.outstandingPutCount_=0,h.outstandingGetCount_=0,h.onDisconnectRequestQueue_=[],h.connected_=!1,h.reconnectDelay_=Me,h.maxReconnectDelay_=3e5,h.securityDebugCallback_=null,h.lastSessionId=null,h.establishConnectionTimer_=null,h.visible_=!1,h.requestCBHash_={},h.requestNumber_=0,h.realtime_=null,h.authToken_=null,h.appCheckToken_=null,h.forceTokenRefresh_=!1,h.invalidAuthTokenCount_=0,h.invalidAppCheckTokenCount_=0,h.firstConnection_=!0,h.lastConnectionAttemptTime_=null,h.lastConnectionEstablishedTime_=null,c&&!(0,o.isNodeSdk)())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");return Oe.getInstance().on("visible",h.onVisible_,h),-1===n.host.indexOf("fblocal")&&fe.getInstance().on("online",h.onOnline_,h),h}return(0,a.__extends)(t,e),t.prototype.sendRequest=function(e,t,n){var r=++this.requestNumber_,i={r:r,a:e,b:t};this.log_((0,o.stringify)(i)),(0,o.assert)(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(i),n&&(this.requestCBHash_[r]=n)},t.prototype.get=function(e){var t=this;this.initConnection_();var n=new o.Deferred,r={p:e._path.toString(),q:e._queryObject},i={action:"g",request:r,onComplete:function(e){var i=e.d;"ok"===e.s?(t.onDataUpdate_(r.p,i,!1,null),n.resolve(i)):n.reject(i)}};this.outstandingGets_.push(i),this.outstandingGetCount_++;var a=this.outstandingGets_.length-1;return this.connected_||setTimeout((function(){var e=t.outstandingGets_[a];void 0!==e&&i===e&&(delete t.outstandingGets_[a],t.outstandingGetCount_--,0===t.outstandingGetCount_&&(t.outstandingGets_=[]),t.log_("get "+a+" timed out on connection"),n.reject(new Error("Client is offline.")))}),3e3),this.connected_&&this.sendGet_(a),n.promise},t.prototype.listen=function(e,t,n,r){this.initConnection_();var i=e._queryIdentifier,a=e._path.toString();this.log_("Listen called for "+a+" "+i),this.listens.has(a)||this.listens.set(a,new Map),(0,o.assert)(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),(0,o.assert)(!this.listens.get(a).has(i),"listen() called twice for same path/queryId.");var s={onComplete:r,hashFn:t,query:e,tag:n};this.listens.get(a).set(i,s),this.connected_&&this.sendListen_(s)},t.prototype.sendGet_=function(e){var t=this,n=this.outstandingGets_[e];this.sendRequest("g",n.request,(function(r){delete t.outstandingGets_[e],t.outstandingGetCount_--,0===t.outstandingGetCount_&&(t.outstandingGets_=[]),n.onComplete&&n.onComplete(r)}))},t.prototype.sendListen_=function(e){var n=this,r=e.query,i=r._path.toString(),o=r._queryIdentifier;this.log_("Listen on "+i+" for "+o);var a={p:i};e.tag&&(a.q=r._queryObject,a.t=e.tag),a.h=e.hashFn(),this.sendRequest("q",a,(function(a){var s=a.d,u=a.s;t.warnOnListenWarnings_(s,r),(n.listens.get(i)&&n.listens.get(i).get(o))===e&&(n.log_("listen response",a),"ok"!==u&&n.removeListen_(i,o),e.onComplete&&e.onComplete(u,s))}))},t.warnOnListenWarnings_=function(e,t){if(e&&"object"===typeof e&&(0,o.contains)(e,"w")){var n=(0,o.safeGet)(e,"w");if(Array.isArray(n)&&~n.indexOf("no_index")){var r='".indexOn": "'+t._queryParams.getIndex().toString()+'"',i=t._path.toString();S("Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding "+r+" at "+i+" to your security rules for better performance.")}}},t.prototype.refreshAuthToken=function(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},(function(){})),this.reduceReconnectDelayIfAdminCredential_(e)},t.prototype.reduceReconnectDelayIfAdminCredential_=function(e){(e&&40===e.length||(0,o.isAdmin)(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)},t.prototype.refreshAppCheckToken=function(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},(function(){}))},t.prototype.tryAuth=function(){var e=this;if(this.connected_&&this.authToken_){var t=this.authToken_,n=(0,o.isValidFormat)(t)?"auth":"gauth",r={cred:t};null===this.authOverride_?r.noauth=!0:"object"===typeof this.authOverride_&&(r.authvar=this.authOverride_),this.sendRequest(n,r,(function(n){var r=n.s,i=n.d||"error";e.authToken_===t&&("ok"===r?e.invalidAuthTokenCount_=0:e.onAuthRevoked_(r,i))}))}},t.prototype.tryAppCheck=function(){var e=this;this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},(function(t){var n=t.s,r=t.d||"error";"ok"===n?e.invalidAppCheckTokenCount_=0:e.onAppCheckRevoked_(n,r)}))},t.prototype.unlisten=function(e,t){var n=e._path.toString(),r=e._queryIdentifier;this.log_("Unlisten called for "+n+" "+r),(0,o.assert)(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(n,r)&&this.connected_&&this.sendUnlisten_(n,r,e._queryObject,t)},t.prototype.sendUnlisten_=function(e,t,n,r){this.log_("Unlisten on "+e+" for "+t);var i={p:e};r&&(i.q=n,i.t=r),this.sendRequest("n",i)},t.prototype.onDisconnectPut=function(e,t,n){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:n})},t.prototype.onDisconnectMerge=function(e,t,n){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:n})},t.prototype.onDisconnectCancel=function(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})},t.prototype.sendOnDisconnect_=function(e,t,n,r){var i={p:t,d:n};this.log_("onDisconnect "+e,i),this.sendRequest(e,i,(function(e){r&&setTimeout((function(){r(e.s,e.d)}),Math.floor(0))}))},t.prototype.put=function(e,t,n,r){this.putInternal("p",e,t,n,r)},t.prototype.merge=function(e,t,n,r){this.putInternal("m",e,t,n,r)},t.prototype.putInternal=function(e,t,n,r,i){this.initConnection_();var o={p:t,d:n};void 0!==i&&(o.h=i),this.outstandingPuts_.push({action:e,request:o,onComplete:r}),this.outstandingPutCount_++;var a=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(a):this.log_("Buffering put: "+t)},t.prototype.sendPut_=function(e){var t=this,n=this.outstandingPuts_[e].action,r=this.outstandingPuts_[e].request,i=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(n,r,(function(r){t.log_(n+" response",r),delete t.outstandingPuts_[e],t.outstandingPutCount_--,0===t.outstandingPutCount_&&(t.outstandingPuts_=[]),i&&i(r.s,r.d)}))},t.prototype.reportStats=function(e){var t=this;if(this.connected_){var n={c:e};this.log_("reportStats",n),this.sendRequest("s",n,(function(e){if("ok"!==e.s){var n=e.d;t.log_("reportStats","Error sending stats: "+n)}}))}},t.prototype.onDataMessage_=function(e){if("r"in e){this.log_("from server: "+(0,o.stringify)(e));var t=e.r,n=this.requestCBHash_[t];n&&(delete this.requestCBHash_[t],n(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}},t.prototype.onDataPush_=function(e,t){this.log_("handleServerMessage",e,t),"d"===e?this.onDataUpdate_(t.p,t.d,!1,t.t):"m"===e?this.onDataUpdate_(t.p,t.d,!0,t.t):"c"===e?this.onListenRevoked_(t.p,t.q):"ac"===e?this.onAuthRevoked_(t.s,t.d):"apc"===e?this.onAppCheckRevoked_(t.s,t.d):"sd"===e?this.onSecurityDebugPacket_(t):I("Unrecognized action received from server: "+(0,o.stringify)(e)+"\nAre you using the latest client?")},t.prototype.onReady_=function(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)},t.prototype.scheduleConnect_=function(e){var t=this;(0,o.assert)(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout((function(){t.establishConnectionTimer_=null,t.establishConnection_()}),Math.floor(e))},t.prototype.initConnection_=function(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)},t.prototype.onVisible_=function(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Me,this.realtime_||this.scheduleConnect_(0)),this.visible_=e},t.prototype.onOnline_=function(e){e?(this.log_("Browser went online."),this.reconnectDelay_=Me,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())},t.prototype.onRealtimeDisconnect_=function(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){if(this.visible_){if(this.lastConnectionEstablishedTime_){(new Date).getTime()-this.lastConnectionEstablishedTime_>3e4&&(this.reconnectDelay_=Me),this.lastConnectionEstablishedTime_=null}}else this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime();var e=(new Date).getTime()-this.lastConnectionAttemptTime_,t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)},t.prototype.establishConnection_=function(){return(0,a.__awaiter)(this,void 0,void 0,(function(){var e,n,r,i,s,u,l,c,h,d,p,f,_,v,y=this;return(0,a.__generator)(this,(function(g){switch(g.label){case 0:if(!this.shouldReconnect_())return[3,4];this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=(new Date).getTime(),this.lastConnectionEstablishedTime_=null,e=this.onDataMessage_.bind(this),n=this.onReady_.bind(this),r=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+t.nextConnectionId_++,s=this.lastSessionId,u=!1,l=null,c=function(){l?l.close():(u=!0,r())},h=function(e){(0,o.assert)(l,"sendRequest call when we're not connected not allowed."),l.sendRequest(e)},this.realtime_={close:c,sendRequest:h},d=this.forceTokenRefresh_,this.forceTokenRefresh_=!1,g.label=1;case 1:return g.trys.push([1,3,,4]),[4,Promise.all([this.authTokenProvider_.getToken(d),this.appCheckTokenProvider_.getToken(d)])];case 2:return p=a.__read.apply(void 0,[g.sent(),2]),f=p[0],_=p[1],u?T("getToken() completed but was canceled"):(T("getToken() completed. Creating connection."),this.authToken_=f&&f.accessToken,this.appCheckToken_=_&&_.token,l=new he(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,n,r,(function(e){S(e+" ("+y.repoInfo_.toString()+")"),y.interrupt("server_kill")}),s)),[3,4];case 3:return v=g.sent(),this.log_("Failed to get token: "+v),u||(this.repoInfo_.nodeAdmin&&S(v),c()),[3,4];case 4:return[2]}}))}))},t.prototype.interrupt=function(e){T("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())},t.prototype.resume=function(e){T("Resuming connection for reason: "+e),delete this.interruptReasons_[e],(0,o.isEmpty)(this.interruptReasons_)&&(this.reconnectDelay_=Me,this.realtime_||this.scheduleConnect_(0))},t.prototype.handleTimestamp_=function(e){var t=e-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:t})},t.prototype.cancelSentTransactions_=function(){for(var e=0;e<this.outstandingPuts_.length;e++){var t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])},t.prototype.onListenRevoked_=function(e,t){var n;n=t?t.map((function(e){return O(e)})).join("$"):"default";var r=this.removeListen_(e,n);r&&r.onComplete&&r.onComplete("permission_denied")},t.prototype.removeListen_=function(e,t){var n,r=new _e(e).toString();if(this.listens.has(r)){var i=this.listens.get(r);n=i.get(t),i.delete(t),0===i.size&&this.listens.delete(r)}else n=void 0;return n},t.prototype.onAuthRevoked_=function(e,t){T("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),"invalid_token"!==e&&"permission_denied"!==e||(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))},t.prototype.onAppCheckRevoked_=function(e,t){T("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,"invalid_token"!==e&&"permission_denied"!==e||(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=3&&this.appCheckTokenProvider_.notifyForInvalidToken())},t.prototype.onSecurityDebugPacket_=function(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e.msg.replace("\n","\nFIREBASE: "))},t.prototype.restoreState_=function(){var e,t,n,r;this.tryAuth(),this.tryAppCheck();try{for(var i=(0,a.__values)(this.listens.values()),o=i.next();!o.done;o=i.next()){var s=o.value;try{for(var u=(n=void 0,(0,a.__values)(s.values())),l=u.next();!l.done;l=u.next()){var c=l.value;this.sendListen_(c)}}catch(p){n={error:p}}finally{try{l&&!l.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}}}catch(f){e={error:f}}finally{try{o&&!o.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}for(var h=0;h<this.outstandingPuts_.length;h++)this.outstandingPuts_[h]&&this.sendPut_(h);for(;this.onDisconnectRequestQueue_.length;){var d=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(d.action,d.pathString,d.data,d.onComplete)}for(h=0;h<this.outstandingGets_.length;h++)this.outstandingGets_[h]&&this.sendGet_(h)},t.prototype.sendConnectStats_=function(){var e={},t="js";(0,o.isNodeSdk)()&&(t=this.repoInfo_.nodeAdmin?"admin_node":"node"),e["sdk."+t+"."+l.replace(/\./g,"-")]=1,(0,o.isMobileCordova)()?e["framework.cordova"]=1:(0,o.isReactNative)()&&(e["framework.reactnative"]=1),this.reportStats(e)},t.prototype.shouldReconnect_=function(){var e=fe.getInstance().currentlyOnline();return(0,o.isEmpty)(this.interruptReasons_)&&e},t.nextPersistentConnectionId_=0,t.nextConnectionId_=0,t}(de),Fe=function(){function e(e,t){this.name=e,this.node=t}return e.Wrap=function(t,n){return new e(t,n)},e}(),Le=function(){function e(){}return e.prototype.getCompare=function(){return this.compare.bind(this)},e.prototype.indexedValueChanged=function(e,t){var n=new Fe(x,e),r=new Fe(x,t);return 0!==this.compare(n,r)},e.prototype.minPost=function(){return Fe.MIN},e}(),We=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,a.__extends)(t,e),Object.defineProperty(t,"__EMPTY_NODE",{get:function(){return Ae},set:function(e){Ae=e},enumerable:!1,configurable:!0}),t.prototype.compare=function(e,t){return R(e.name,t.name)},t.prototype.isDefinedOn=function(e){throw(0,o.assertionError)("KeyIndex.isDefinedOn not expected to be called.")},t.prototype.indexedValueChanged=function(e,t){return!1},t.prototype.minPost=function(){return Fe.MIN},t.prototype.maxPost=function(){return new Fe(N,Ae)},t.prototype.makePost=function(e,t){return(0,o.assert)("string"===typeof e,"KeyIndex indexValue must always be a string."),new Fe(e,Ae)},t.prototype.toString=function(){return".key"},t}(Le),Ue=new We,je=function(){function e(e,t,n,r,i){void 0===i&&(i=null),this.isReverse_=r,this.resultGenerator_=i,this.nodeStack_=[];for(var o=1;!e.isEmpty();)if(e=e,o=t?n(e.key,t):1,r&&(o*=-1),o<0)e=this.isReverse_?e.left:e.right;else{if(0===o){this.nodeStack_.push(e);break}this.nodeStack_.push(e),e=this.isReverse_?e.right:e.left}}return e.prototype.getNext=function(){if(0===this.nodeStack_.length)return null;var e,t=this.nodeStack_.pop();if(e=this.resultGenerator_?this.resultGenerator_(t.key,t.value):{key:t.key,value:t.value},this.isReverse_)for(t=t.left;!t.isEmpty();)this.nodeStack_.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack_.push(t),t=t.left;return e},e.prototype.hasNext=function(){return this.nodeStack_.length>0},e.prototype.peek=function(){if(0===this.nodeStack_.length)return null;var e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}},e}(),Be=function(){function e(t,n,r,i,o){this.key=t,this.value=n,this.color=null!=r?r:e.RED,this.left=null!=i?i:Qe.EMPTY_NODE,this.right=null!=o?o:Qe.EMPTY_NODE}return e.prototype.copy=function(t,n,r,i,o){return new e(null!=t?t:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=o?o:this.right)},e.prototype.count=function(){return this.left.count()+1+this.right.count()},e.prototype.isEmpty=function(){return!1},e.prototype.inorderTraversal=function(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)},e.prototype.reverseTraversal=function(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)},e.prototype.min_=function(){return this.left.isEmpty()?this:this.left.min_()},e.prototype.minKey=function(){return this.min_().key},e.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},e.prototype.insert=function(e,t,n){var r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp_()},e.prototype.removeMin_=function(){if(this.left.isEmpty())return Qe.EMPTY_NODE;var e=this;return e.left.isRed_()||e.left.left.isRed_()||(e=e.moveRedLeft_()),(e=e.copy(null,null,null,e.left.removeMin_(),null)).fixUp_()},e.prototype.remove=function(e,t){var n,r;if(t(e,(n=this).key)<0)n.left.isEmpty()||n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.remove(e,t),null);else{if(n.left.isRed_()&&(n=n.rotateRight_()),n.right.isEmpty()||n.right.isRed_()||n.right.left.isRed_()||(n=n.moveRedRight_()),0===t(e,n.key)){if(n.right.isEmpty())return Qe.EMPTY_NODE;r=n.right.min_(),n=n.copy(r.key,r.value,null,null,n.right.removeMin_())}n=n.copy(null,null,null,null,n.right.remove(e,t))}return n.fixUp_()},e.prototype.isRed_=function(){return this.color},e.prototype.fixUp_=function(){var e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e},e.prototype.moveRedLeft_=function(){var e=this.colorFlip_();return e.right.left.isRed_()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight_())).rotateLeft_()).colorFlip_()),e},e.prototype.moveRedRight_=function(){var e=this.colorFlip_();return e.left.left.isRed_()&&(e=(e=e.rotateRight_()).colorFlip_()),e},e.prototype.rotateLeft_=function(){var t=this.copy(null,null,e.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},e.prototype.rotateRight_=function(){var t=this.copy(null,null,e.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},e.prototype.colorFlip_=function(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)},e.prototype.checkMaxDepth_=function(){var e=this.check_();return Math.pow(2,e)<=this.count()+1},e.prototype.check_=function(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");var e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)},e.RED=!0,e.BLACK=!1,e}(),Ve=function(){function e(){}return e.prototype.copy=function(e,t,n,r,i){return this},e.prototype.insert=function(e,t,n){return new Be(e,t,null)},e.prototype.remove=function(e,t){return this},e.prototype.count=function(){return 0},e.prototype.isEmpty=function(){return!0},e.prototype.inorderTraversal=function(e){return!1},e.prototype.reverseTraversal=function(e){return!1},e.prototype.minKey=function(){return null},e.prototype.maxKey=function(){return null},e.prototype.check_=function(){return 0},e.prototype.isRed_=function(){return!1},e}(),Qe=function(){function e(t,n){void 0===n&&(n=e.EMPTY_NODE),this.comparator_=t,this.root_=n}return e.prototype.insert=function(t,n){return new e(this.comparator_,this.root_.insert(t,n,this.comparator_).copy(null,null,Be.BLACK,null,null))},e.prototype.remove=function(t){return new e(this.comparator_,this.root_.remove(t,this.comparator_).copy(null,null,Be.BLACK,null,null))},e.prototype.get=function(e){for(var t,n=this.root_;!n.isEmpty();){if(0===(t=this.comparator_(e,n.key)))return n.value;t<0?n=n.left:t>0&&(n=n.right)}return null},e.prototype.getPredecessorKey=function(e){for(var t,n=this.root_,r=null;!n.isEmpty();){if(0===(t=this.comparator_(e,n.key))){if(n.left.isEmpty())return r?r.key:null;for(n=n.left;!n.right.isEmpty();)n=n.right;return n.key}t<0?n=n.left:t>0&&(r=n,n=n.right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")},e.prototype.isEmpty=function(){return this.root_.isEmpty()},e.prototype.count=function(){return this.root_.count()},e.prototype.minKey=function(){return this.root_.minKey()},e.prototype.maxKey=function(){return this.root_.maxKey()},e.prototype.inorderTraversal=function(e){return this.root_.inorderTraversal(e)},e.prototype.reverseTraversal=function(e){return this.root_.reverseTraversal(e)},e.prototype.getIterator=function(e){return new je(this.root_,null,this.comparator_,!1,e)},e.prototype.getIteratorFrom=function(e,t){return new je(this.root_,e,this.comparator_,!1,t)},e.prototype.getReverseIteratorFrom=function(e,t){return new je(this.root_,e,this.comparator_,!0,t)},e.prototype.getReverseIterator=function(e){return new je(this.root_,null,this.comparator_,!0,e)},e.EMPTY_NODE=new Ve,e}();function He(e,t){return R(e.name,t.name)}function ze(e,t){return R(e,t)}var Ye,Ke,Ge,$e=function(e){return"number"===typeof e?"number:"+F(e):"string:"+e},Je=function(e){if(e.isLeafNode()){var t=e.val();(0,o.assert)("string"===typeof t||"number"===typeof t||"object"===typeof t&&(0,o.contains)(t,".sv"),"Priority must be a string or number.")}else(0,o.assert)(e===De||e.isEmpty(),"priority of unexpected type.");(0,o.assert)(e===De||e.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")},Xe=function(){function e(t,n){void 0===n&&(n=e.__childrenNodeConstructor.EMPTY_NODE),this.value_=t,this.priorityNode_=n,this.lazyHash_=null,(0,o.assert)(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),Je(this.priorityNode_)}return Object.defineProperty(e,"__childrenNodeConstructor",{get:function(){return Ye},set:function(e){Ye=e},enumerable:!1,configurable:!0}),e.prototype.isLeafNode=function(){return!0},e.prototype.getPriority=function(){return this.priorityNode_},e.prototype.updatePriority=function(t){return new e(this.value_,t)},e.prototype.getImmediateChild=function(t){return".priority"===t?this.priorityNode_:e.__childrenNodeConstructor.EMPTY_NODE},e.prototype.getChild=function(t){return ke(t)?this:".priority"===ye(t)?this.priorityNode_:e.__childrenNodeConstructor.EMPTY_NODE},e.prototype.hasChild=function(){return!1},e.prototype.getPredecessorChildName=function(e,t){return null},e.prototype.updateImmediateChild=function(t,n){return".priority"===t?this.updatePriority(n):n.isEmpty()&&".priority"!==t?this:e.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,n).updatePriority(this.priorityNode_)},e.prototype.updateChild=function(t,n){var r=ye(t);return null===r?n:n.isEmpty()&&".priority"!==r?this:((0,o.assert)(".priority"!==r||1===ge(t),".priority must be the last token in a path"),this.updateImmediateChild(r,e.__childrenNodeConstructor.EMPTY_NODE.updateChild(me(t),n)))},e.prototype.isEmpty=function(){return!1},e.prototype.numChildren=function(){return 0},e.prototype.forEachChild=function(e,t){return!1},e.prototype.val=function(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()},e.prototype.hash=function(){if(null===this.lazyHash_){var e="";this.priorityNode_.isEmpty()||(e+="priority:"+$e(this.priorityNode_.val())+":");var t=typeof this.value_;e+=t+":",e+="number"===t?F(this.value_):this.value_,this.lazyHash_=g(e)}return this.lazyHash_},e.prototype.getValue=function(){return this.value_},e.prototype.compareTo=function(t){return t===e.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof e.__childrenNodeConstructor?-1:((0,o.assert)(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))},e.prototype.compareToLeafNode_=function(t){var n=typeof t.value_,r=typeof this.value_,i=e.VALUE_TYPE_ORDER.indexOf(n),a=e.VALUE_TYPE_ORDER.indexOf(r);return(0,o.assert)(i>=0,"Unknown leaf type: "+n),(0,o.assert)(a>=0,"Unknown leaf type: "+r),i===a?"object"===r?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:a-i},e.prototype.withIndex=function(){return this},e.prototype.isIndexed=function(){return!0},e.prototype.equals=function(e){if(e===this)return!0;if(e.isLeafNode()){var t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}return!1},e.VALUE_TYPE_ORDER=["object","boolean","number","string"],e}();var Ze,et,tt=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,a.__extends)(t,e),t.prototype.compare=function(e,t){var n=e.node.getPriority(),r=t.node.getPriority(),i=n.compareTo(r);return 0===i?R(e.name,t.name):i},t.prototype.isDefinedOn=function(e){return!e.getPriority().isEmpty()},t.prototype.indexedValueChanged=function(e,t){return!e.getPriority().equals(t.getPriority())},t.prototype.minPost=function(){return Fe.MIN},t.prototype.maxPost=function(){return new Fe(N,new Xe("[PRIORITY-POST]",Ge))},t.prototype.makePost=function(e,t){var n=Ke(e);return new Fe(t,new Xe("[PRIORITY-POST]",n))},t.prototype.toString=function(){return".priority"},t}(Le)),nt=Math.log(2),rt=function(){function e(e){var t;this.count=(t=e+1,parseInt(Math.log(t)/nt,10)),this.current_=this.count-1;var n,r=(n=this.count,parseInt(Array(n+1).join("1"),2));this.bits_=e+1&r}return e.prototype.nextBitIsOne=function(){var e=!(this.bits_&1<<this.current_);return this.current_--,e},e}(),it=function(e,t,n,r){e.sort(t);var i=function(t,r){var o,a,s=r-t;if(0===s)return null;if(1===s)return o=e[t],a=n?n(o):o,new Be(a,o.node,Be.BLACK,null,null);var u=parseInt(s/2,10)+t,l=i(t,u),c=i(u+1,r);return o=e[u],a=n?n(o):o,new Be(a,o.node,Be.BLACK,l,c)},o=function(t){for(var r=null,o=null,a=e.length,s=function(t,r){var o=a-t,s=a;a-=t;var l=i(o+1,s),c=e[o],h=n?n(c):c;u(new Be(h,c.node,r,null,l))},u=function(e){r?(r.left=e,r=e):(o=e,r=e)},l=0;l<t.count;++l){var c=t.nextBitIsOne(),h=Math.pow(2,t.count-(l+1));c?s(h,Be.BLACK):(s(h,Be.BLACK),s(h,Be.RED))}return o}(new rt(e.length));return new Qe(r||t,o)},ot={},at=function(){function e(e,t){this.indexes_=e,this.indexSet_=t}return Object.defineProperty(e,"Default",{get:function(){return(0,o.assert)(ot&&tt,"ChildrenNode.ts has not been loaded"),Ze=Ze||new e({".priority":ot},{".priority":tt})},enumerable:!1,configurable:!0}),e.prototype.get=function(e){var t=(0,o.safeGet)(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof Qe?t:null},e.prototype.hasIndex=function(e){return(0,o.contains)(this.indexSet_,e.toString())},e.prototype.addIndex=function(t,n){(0,o.assert)(t!==Ue,"KeyIndex always exists and isn't meant to be added to the IndexMap.");for(var r,i=[],s=!1,u=n.getIterator(Fe.Wrap),l=u.getNext();l;)s=s||t.isDefinedOn(l.node),i.push(l),l=u.getNext();r=s?it(i,t.getCompare()):ot;var c=t.toString(),h=(0,a.__assign)({},this.indexSet_);h[c]=t;var d=(0,a.__assign)({},this.indexes_);return d[c]=r,new e(d,h)},e.prototype.addToIndexes=function(t,n){var r=this;return new e((0,o.map)(this.indexes_,(function(e,i){var a=(0,o.safeGet)(r.indexSet_,i);if((0,o.assert)(a,"Missing index implementation for "+i),e===ot){if(a.isDefinedOn(t.node)){for(var s=[],u=n.getIterator(Fe.Wrap),l=u.getNext();l;)l.name!==t.name&&s.push(l),l=u.getNext();return s.push(t),it(s,a.getCompare())}return ot}var c=n.get(t.name),h=e;return c&&(h=h.remove(new Fe(t.name,c))),h.insert(t,t.node)})),this.indexSet_)},e.prototype.removeFromIndexes=function(t,n){return new e((0,o.map)(this.indexes_,(function(e){if(e===ot)return e;var r=n.get(t.name);return r?e.remove(new Fe(t.name,r)):e})),this.indexSet_)},e}(),st=function(){function e(e,t,n){this.children_=e,this.priorityNode_=t,this.indexMap_=n,this.lazyHash_=null,this.priorityNode_&&Je(this.priorityNode_),this.children_.isEmpty()&&(0,o.assert)(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}return Object.defineProperty(e,"EMPTY_NODE",{get:function(){return et||(et=new e(new Qe(ze),null,at.Default))},enumerable:!1,configurable:!0}),e.prototype.isLeafNode=function(){return!1},e.prototype.getPriority=function(){return this.priorityNode_||et},e.prototype.updatePriority=function(t){return this.children_.isEmpty()?this:new e(this.children_,t,this.indexMap_)},e.prototype.getImmediateChild=function(e){if(".priority"===e)return this.getPriority();var t=this.children_.get(e);return null===t?et:t},e.prototype.getChild=function(e){var t=ye(e);return null===t?this:this.getImmediateChild(t).getChild(me(e))},e.prototype.hasChild=function(e){return null!==this.children_.get(e)},e.prototype.updateImmediateChild=function(t,n){if((0,o.assert)(n,"We should always be passing snapshot nodes"),".priority"===t)return this.updatePriority(n);var r=new Fe(t,n),i=void 0,a=void 0;n.isEmpty()?(i=this.children_.remove(t),a=this.indexMap_.removeFromIndexes(r,this.children_)):(i=this.children_.insert(t,n),a=this.indexMap_.addToIndexes(r,this.children_));var s=i.isEmpty()?et:this.priorityNode_;return new e(i,s,a)},e.prototype.updateChild=function(e,t){var n=ye(e);if(null===n)return t;(0,o.assert)(".priority"!==ye(e)||1===ge(e),".priority must be the last token in a path");var r=this.getImmediateChild(n).updateChild(me(e),t);return this.updateImmediateChild(n,r)},e.prototype.isEmpty=function(){return this.children_.isEmpty()},e.prototype.numChildren=function(){return this.children_.count()},e.prototype.val=function(t){if(this.isEmpty())return null;var n={},r=0,i=0,o=!0;if(this.forEachChild(tt,(function(a,s){n[a]=s.val(t),r++,o&&e.INTEGER_REGEXP_.test(a)?i=Math.max(i,Number(a)):o=!1})),!t&&o&&i<2*r){var a=[];for(var s in n)a[s]=n[s];return a}return t&&!this.getPriority().isEmpty()&&(n[".priority"]=this.getPriority().val()),n},e.prototype.hash=function(){if(null===this.lazyHash_){var e="";this.getPriority().isEmpty()||(e+="priority:"+$e(this.getPriority().val())+":"),this.forEachChild(tt,(function(t,n){var r=n.hash();""!==r&&(e+=":"+t+":"+r)})),this.lazyHash_=""===e?"":g(e)}return this.lazyHash_},e.prototype.getPredecessorChildName=function(e,t,n){var r=this.resolveIndex_(n);if(r){var i=r.getPredecessorKey(new Fe(e,t));return i?i.name:null}return this.children_.getPredecessorKey(e)},e.prototype.getFirstChildName=function(e){var t=this.resolveIndex_(e);if(t){var n=t.minKey();return n&&n.name}return this.children_.minKey()},e.prototype.getFirstChild=function(e){var t=this.getFirstChildName(e);return t?new Fe(t,this.children_.get(t)):null},e.prototype.getLastChildName=function(e){var t=this.resolveIndex_(e);if(t){var n=t.maxKey();return n&&n.name}return this.children_.maxKey()},e.prototype.getLastChild=function(e){var t=this.getLastChildName(e);return t?new Fe(t,this.children_.get(t)):null},e.prototype.forEachChild=function(e,t){var n=this.resolveIndex_(e);return n?n.inorderTraversal((function(e){return t(e.name,e.node)})):this.children_.inorderTraversal(t)},e.prototype.getIterator=function(e){return this.getIteratorFrom(e.minPost(),e)},e.prototype.getIteratorFrom=function(e,t){var n=this.resolveIndex_(t);if(n)return n.getIteratorFrom(e,(function(e){return e}));for(var r=this.children_.getIteratorFrom(e.name,Fe.Wrap),i=r.peek();null!=i&&t.compare(i,e)<0;)r.getNext(),i=r.peek();return r},e.prototype.getReverseIterator=function(e){return this.getReverseIteratorFrom(e.maxPost(),e)},e.prototype.getReverseIteratorFrom=function(e,t){var n=this.resolveIndex_(t);if(n)return n.getReverseIteratorFrom(e,(function(e){return e}));for(var r=this.children_.getReverseIteratorFrom(e.name,Fe.Wrap),i=r.peek();null!=i&&t.compare(i,e)>0;)r.getNext(),i=r.peek();return r},e.prototype.compareTo=function(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===ut?-1:0},e.prototype.withIndex=function(t){if(t===Ue||this.indexMap_.hasIndex(t))return this;var n=this.indexMap_.addIndex(t,this.children_);return new e(this.children_,this.priorityNode_,n)},e.prototype.isIndexed=function(e){return e===Ue||this.indexMap_.hasIndex(e)},e.prototype.equals=function(e){if(e===this)return!0;if(e.isLeafNode())return!1;var t=e;if(this.getPriority().equals(t.getPriority())){if(this.children_.count()===t.children_.count()){for(var n=this.getIterator(tt),r=t.getIterator(tt),i=n.getNext(),o=r.getNext();i&&o;){if(i.name!==o.name||!i.node.equals(o.node))return!1;i=n.getNext(),o=r.getNext()}return null===i&&null===o}return!1}return!1},e.prototype.resolveIndex_=function(e){return e===Ue?null:this.indexMap_.get(e.toString())},e.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,e}(),ut=new(function(e){function t(){return e.call(this,new Qe(ze),st.EMPTY_NODE,at.Default)||this}return(0,a.__extends)(t,e),t.prototype.compareTo=function(e){return e===this?0:1},t.prototype.equals=function(e){return e===this},t.prototype.getPriority=function(){return this},t.prototype.getImmediateChild=function(e){return st.EMPTY_NODE},t.prototype.isEmpty=function(){return!1},t}(st));Object.defineProperties(Fe,{MIN:{value:new Fe(x,st.EMPTY_NODE)},MAX:{value:new Fe(N,ut)}}),We.__EMPTY_NODE=st.EMPTY_NODE,Xe.__childrenNodeConstructor=st,De=ut,function(e){Ge=e}(ut);function lt(e,t){if(void 0===t&&(t=null),null===e)return st.EMPTY_NODE;if("object"===typeof e&&".priority"in e&&(t=e[".priority"]),(0,o.assert)(null===t||"string"===typeof t||"number"===typeof t||"object"===typeof t&&".sv"in t,"Invalid priority type found: "+typeof t),"object"===typeof e&&".value"in e&&null!==e[".value"]&&(e=e[".value"]),"object"!==typeof e||".sv"in e)return new Xe(e,lt(t));if(e instanceof Array){var n=st.EMPTY_NODE;return q(e,(function(t,r){if((0,o.contains)(e,t)&&"."!==t.substring(0,1)){var i=lt(r);!i.isLeafNode()&&i.isEmpty()||(n=n.updateImmediateChild(t,i))}})),n.updatePriority(lt(t))}var r=[],i=!1;if(q(e,(function(e,t){if("."!==e.substring(0,1)){var n=lt(t);n.isEmpty()||(i=i||!n.getPriority().isEmpty(),r.push(new Fe(e,n)))}})),0===r.length)return st.EMPTY_NODE;var a=it(r,He,(function(e){return e.name}),ze);if(i){var s=it(r,tt.getCompare());return new st(a,lt(t),new at({".priority":s},{".priority":tt}))}return new st(a,lt(t),at.Default)}!function(e){Ke=e}(lt);var ct=function(e){function t(t){var n=e.call(this)||this;return n.indexPath_=t,(0,o.assert)(!ke(t)&&".priority"!==ye(t),"Can't create PathIndex with empty path or .priority key"),n}return(0,a.__extends)(t,e),t.prototype.extractChild=function(e){return e.getChild(this.indexPath_)},t.prototype.isDefinedOn=function(e){return!e.getChild(this.indexPath_).isEmpty()},t.prototype.compare=function(e,t){var n=this.extractChild(e.node),r=this.extractChild(t.node),i=n.compareTo(r);return 0===i?R(e.name,t.name):i},t.prototype.makePost=function(e,t){var n=lt(e),r=st.EMPTY_NODE.updateChild(this.indexPath_,n);return new Fe(t,r)},t.prototype.maxPost=function(){var e=st.EMPTY_NODE.updateChild(this.indexPath_,ut);return new Fe(N,e)},t.prototype.toString=function(){return we(this.indexPath_,0).join("/")},t}(Le),ht=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,a.__extends)(t,e),t.prototype.compare=function(e,t){var n=e.node.compareTo(t.node);return 0===n?R(e.name,t.name):n},t.prototype.isDefinedOn=function(e){return!0},t.prototype.indexedValueChanged=function(e,t){return!e.equals(t)},t.prototype.minPost=function(){return Fe.MIN},t.prototype.maxPost=function(){return Fe.MAX},t.prototype.makePost=function(e,t){var n=lt(e);return new Fe(t,n)},t.prototype.toString=function(){return".value"},t}(Le)),dt="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",pt=function(){var e=0,t=[];return function(n){var r,i=n===e;e=n;var a=new Array(8);for(r=7;r>=0;r--)a[r]=dt.charAt(n%64),n=Math.floor(n/64);(0,o.assert)(0===n,"Cannot push at time == 0");var s=a.join("");if(i){for(r=11;r>=0&&63===t[r];r--)t[r]=0;t[r]++}else for(r=0;r<12;r++)t[r]=Math.floor(64*Math.random());for(r=0;r<12;r++)s+=dt.charAt(t[r]);return(0,o.assert)(20===s.length,"nextPushId: Length should be 20."),s}}(),ft=function(e){if("2147483647"===e)return"-";var t=j(e);if(null!=t)return""+(t+1);for(var n=new Array(e.length),r=0;r<n.length;r++)n[r]=e.charAt(r);if(n.length<786)return n.push("-"),n.join("");for(var i=n.length-1;i>=0&&"z"===n[i];)i--;if(-1===i)return N;var o=n[i],a=dt.charAt(dt.indexOf(o)+1);return n[i]=a,n.slice(0,i+1).join("")},_t=function(e){if("-2147483648"===e)return x;var t=j(e);if(null!=t)return""+(t-1);for(var n=new Array(e.length),r=0;r<n.length;r++)n[r]=e.charAt(r);return"-"===n[n.length-1]?1===n.length?"2147483647":(delete n[n.length-1],n.join("")):(n[n.length-1]=dt.charAt(dt.indexOf(n[n.length-1])-1),n.join("")+"z".repeat(786-n.length))};function vt(e){return{type:"value",snapshotNode:e}}function yt(e,t){return{type:"child_added",snapshotNode:t,childName:e}}function gt(e,t){return{type:"child_removed",snapshotNode:t,childName:e}}function mt(e,t,n){return{type:"child_changed",snapshotNode:t,childName:e,oldSnap:n}}var Ct=function(){function e(e){this.index_=e}return e.prototype.updateChild=function(e,t,n,r,i,a){(0,o.assert)(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");var s=e.getImmediateChild(t);return s.getChild(r).equals(n.getChild(r))&&s.isEmpty()===n.isEmpty()?e:(null!=a&&(n.isEmpty()?e.hasChild(t)?a.trackChildChange(gt(t,s)):(0,o.assert)(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):s.isEmpty()?a.trackChildChange(yt(t,n)):a.trackChildChange(mt(t,n,s))),e.isLeafNode()&&n.isEmpty()?e:e.updateImmediateChild(t,n).withIndex(this.index_))},e.prototype.updateFullNode=function(e,t,n){return null!=n&&(e.isLeafNode()||e.forEachChild(tt,(function(e,r){t.hasChild(e)||n.trackChildChange(gt(e,r))})),t.isLeafNode()||t.forEachChild(tt,(function(t,r){if(e.hasChild(t)){var i=e.getImmediateChild(t);i.equals(r)||n.trackChildChange(mt(t,r,i))}else n.trackChildChange(yt(t,r))}))),t.withIndex(this.index_)},e.prototype.updatePriority=function(e,t){return e.isEmpty()?st.EMPTY_NODE:e.updatePriority(t)},e.prototype.filtersNodes=function(){return!1},e.prototype.getIndexedFilter=function(){return this},e.prototype.getIndex=function(){return this.index_},e}(),wt=function(){function e(t){this.indexedFilter_=new Ct(t.getIndex()),this.index_=t.getIndex(),this.startPost_=e.getStartPost_(t),this.endPost_=e.getEndPost_(t)}return e.prototype.getStartPost=function(){return this.startPost_},e.prototype.getEndPost=function(){return this.endPost_},e.prototype.matches=function(e){return this.index_.compare(this.getStartPost(),e)<=0&&this.index_.compare(e,this.getEndPost())<=0},e.prototype.updateChild=function(e,t,n,r,i,o){return this.matches(new Fe(t,n))||(n=st.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,n,r,i,o)},e.prototype.updateFullNode=function(e,t,n){t.isLeafNode()&&(t=st.EMPTY_NODE);var r=t.withIndex(this.index_);r=r.updatePriority(st.EMPTY_NODE);var i=this;return t.forEachChild(tt,(function(e,t){i.matches(new Fe(e,t))||(r=r.updateImmediateChild(e,st.EMPTY_NODE))})),this.indexedFilter_.updateFullNode(e,r,n)},e.prototype.updatePriority=function(e,t){return e},e.prototype.filtersNodes=function(){return!0},e.prototype.getIndexedFilter=function(){return this.indexedFilter_},e.prototype.getIndex=function(){return this.index_},e.getStartPost_=function(e){if(e.hasStart()){var t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}return e.getIndex().minPost()},e.getEndPost_=function(e){if(e.hasEnd()){var t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}return e.getIndex().maxPost()},e}(),bt=function(){function e(e){this.rangedFilter_=new wt(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft()}return e.prototype.updateChild=function(e,t,n,r,i,o){return this.rangedFilter_.matches(new Fe(t,n))||(n=st.EMPTY_NODE),e.getImmediateChild(t).equals(n)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,n,r,i,o):this.fullLimitUpdateChild_(e,t,n,i,o)},e.prototype.updateFullNode=function(e,t,n){var r;if(t.isLeafNode()||t.isEmpty())r=st.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<t.numChildren()&&t.isIndexed(this.index_)){r=st.EMPTY_NODE.withIndex(this.index_);var i=void 0;i=this.reverse_?t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);for(var o=0;i.hasNext()&&o<this.limit_;){var a=i.getNext();if(!(this.reverse_?this.index_.compare(this.rangedFilter_.getStartPost(),a)<=0:this.index_.compare(a,this.rangedFilter_.getEndPost())<=0))break;r=r.updateImmediateChild(a.name,a.node),o++}}else{r=(r=t.withIndex(this.index_)).updatePriority(st.EMPTY_NODE);var s=void 0,u=void 0,l=void 0;i=void 0;if(this.reverse_){i=r.getReverseIterator(this.index_),s=this.rangedFilter_.getEndPost(),u=this.rangedFilter_.getStartPost();var c=this.index_.getCompare();l=function(e,t){return c(t,e)}}else i=r.getIterator(this.index_),s=this.rangedFilter_.getStartPost(),u=this.rangedFilter_.getEndPost(),l=this.index_.getCompare();o=0;for(var h=!1;i.hasNext();){a=i.getNext();!h&&l(s,a)<=0&&(h=!0),h&&o<this.limit_&&l(a,u)<=0?o++:r=r.updateImmediateChild(a.name,st.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,r,n)},e.prototype.updatePriority=function(e,t){return e},e.prototype.filtersNodes=function(){return!0},e.prototype.getIndexedFilter=function(){return this.rangedFilter_.getIndexedFilter()},e.prototype.getIndex=function(){return this.index_},e.prototype.fullLimitUpdateChild_=function(e,t,n,r,i){var a;if(this.reverse_){var s=this.index_.getCompare();a=function(e,t){return s(t,e)}}else a=this.index_.getCompare();var u=e;(0,o.assert)(u.numChildren()===this.limit_,"");var l=new Fe(t,n),c=this.reverse_?u.getFirstChild(this.index_):u.getLastChild(this.index_),h=this.rangedFilter_.matches(l);if(u.hasChild(t)){for(var d=u.getImmediateChild(t),p=r.getChildAfterChild(this.index_,c,this.reverse_);null!=p&&(p.name===t||u.hasChild(p.name));)p=r.getChildAfterChild(this.index_,p,this.reverse_);var f=null==p?1:a(p,l);if(h&&!n.isEmpty()&&f>=0)return null!=i&&i.trackChildChange(mt(t,n,d)),u.updateImmediateChild(t,n);null!=i&&i.trackChildChange(gt(t,d));var _=u.updateImmediateChild(t,st.EMPTY_NODE);return null!=p&&this.rangedFilter_.matches(p)?(null!=i&&i.trackChildChange(yt(p.name,p.node)),_.updateImmediateChild(p.name,p.node)):_}return n.isEmpty()?e:h&&a(c,l)>=0?(null!=i&&(i.trackChildChange(gt(c.name,c.node)),i.trackChildChange(yt(t,n))),u.updateImmediateChild(t,n).updateImmediateChild(c.name,st.EMPTY_NODE)):e},e}(),Tt=function(){function e(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=tt}return e.prototype.hasStart=function(){return this.startSet_},e.prototype.hasStartAfter=function(){return this.startAfterSet_},e.prototype.hasEndBefore=function(){return this.endBeforeSet_},e.prototype.isViewFromLeft=function(){return""===this.viewFrom_?this.startSet_:"l"===this.viewFrom_},e.prototype.getIndexStartValue=function(){return(0,o.assert)(this.startSet_,"Only valid if start has been set"),this.indexStartValue_},e.prototype.getIndexStartName=function(){return(0,o.assert)(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:x},e.prototype.hasEnd=function(){return this.endSet_},e.prototype.getIndexEndValue=function(){return(0,o.assert)(this.endSet_,"Only valid if end has been set"),this.indexEndValue_},e.prototype.getIndexEndName=function(){return(0,o.assert)(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:N},e.prototype.hasLimit=function(){return this.limitSet_},e.prototype.hasAnchoredLimit=function(){return this.limitSet_&&""!==this.viewFrom_},e.prototype.getLimit=function(){return(0,o.assert)(this.limitSet_,"Only valid if limit has been set"),this.limit_},e.prototype.getIndex=function(){return this.index_},e.prototype.loadsAllData=function(){return!(this.startSet_||this.endSet_||this.limitSet_)},e.prototype.isDefault=function(){return this.loadsAllData()&&this.index_===tt},e.prototype.copy=function(){var t=new e;return t.limitSet_=this.limitSet_,t.limit_=this.limit_,t.startSet_=this.startSet_,t.indexStartValue_=this.indexStartValue_,t.startNameSet_=this.startNameSet_,t.indexStartName_=this.indexStartName_,t.endSet_=this.endSet_,t.indexEndValue_=this.indexEndValue_,t.endNameSet_=this.endNameSet_,t.indexEndName_=this.indexEndName_,t.index_=this.index_,t.viewFrom_=this.viewFrom_,t},e}();function kt(e,t,n){var r=e.copy();return r.startSet_=!0,void 0===t&&(t=null),r.indexStartValue_=t,null!=n?(r.startNameSet_=!0,r.indexStartName_=n):(r.startNameSet_=!1,r.indexStartName_=""),r}function It(e,t,n){var r=e.copy();return r.endSet_=!0,void 0===t&&(t=null),r.indexEndValue_=t,void 0!==n?(r.endNameSet_=!0,r.indexEndName_=n):(r.endNameSet_=!1,r.indexEndName_=""),r}function Et(e,t){var n=e.copy();return n.index_=t,n}function St(e){var t,n={};return e.isDefault()||(e.index_===tt?t="$priority":e.index_===ht?t="$value":e.index_===Ue?t="$key":((0,o.assert)(e.index_ instanceof ct,"Unrecognized index type!"),t=e.index_.toString()),n.orderBy=(0,o.stringify)(t),e.startSet_&&(n.startAt=(0,o.stringify)(e.indexStartValue_),e.startNameSet_&&(n.startAt+=","+(0,o.stringify)(e.indexStartName_))),e.endSet_&&(n.endAt=(0,o.stringify)(e.indexEndValue_),e.endNameSet_&&(n.endAt+=","+(0,o.stringify)(e.indexEndName_))),e.limitSet_&&(e.isViewFromLeft()?n.limitToFirst=e.limit_:n.limitToLast=e.limit_)),n}function Pt(e){var t={};if(e.startSet_&&(t.sp=e.indexStartValue_,e.startNameSet_&&(t.sn=e.indexStartName_)),e.endSet_&&(t.ep=e.indexEndValue_,e.endNameSet_&&(t.en=e.indexEndName_)),e.limitSet_){t.l=e.limit_;var n=e.viewFrom_;""===n&&(n=e.isViewFromLeft()?"l":"r"),t.vf=n}return e.index_!==tt&&(t.i=e.index_.toString()),t}var xt=function(e){function t(t,n,r,i){var o=e.call(this)||this;return o.repoInfo_=t,o.onDataUpdate_=n,o.authTokenProvider_=r,o.appCheckTokenProvider_=i,o.log_=k("p:rest:"),o.listens_={},o}return(0,a.__extends)(t,e),t.prototype.reportStats=function(e){throw new Error("Method not implemented.")},t.getListenId_=function(e,t){return void 0!==t?"tag$"+t:((0,o.assert)(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())},t.prototype.listen=function(e,n,r,i){var a=this,s=e._path.toString();this.log_("Listen called for "+s+" "+e._queryIdentifier);var u=t.getListenId_(e,r),l={};this.listens_[u]=l;var c=St(e._queryParams);this.restRequest_(s+".json",c,(function(e,t){var n=t;(404===e&&(n=null,e=null),null===e&&a.onDataUpdate_(s,n,!1,r),(0,o.safeGet)(a.listens_,u)===l)&&i(e?401===e?"permission_denied":"rest_error:"+e:"ok",null)}))},t.prototype.unlisten=function(e,n){var r=t.getListenId_(e,n);delete this.listens_[r]},t.prototype.get=function(e){var t=this,n=St(e._queryParams),r=e._path.toString(),i=new o.Deferred;return this.restRequest_(r+".json",n,(function(e,n){var o=n;404===e&&(o=null,e=null),null===e?(t.onDataUpdate_(r,o,!1,null),i.resolve(o)):i.reject(new Error(o))})),i.promise},t.prototype.refreshAuthToken=function(e){},t.prototype.restRequest_=function(e,t,n){var r=this;return void 0===t&&(t={}),t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then((function(i){var s=(0,a.__read)(i,2),u=s[0],l=s[1];u&&u.accessToken&&(t.auth=u.accessToken),l&&l.token&&(t.ac=l.token);var c=(r.repoInfo_.secure?"https://":"http://")+r.repoInfo_.host+e+"?ns="+r.repoInfo_.namespace+(0,o.querystring)(t);r.log_("Sending REST request for "+c);var h=new XMLHttpRequest;h.onreadystatechange=function(){if(n&&4===h.readyState){r.log_("REST Response for "+c+" received. status:",h.status,"response:",h.responseText);var e=null;if(h.status>=200&&h.status<300){try{e=(0,o.jsonEval)(h.responseText)}catch(t){S("Failed to parse JSON response for "+c+": "+h.responseText)}n(null,e)}else 401!==h.status&&404!==h.status&&S("Got unsuccessful REST response for "+c+" Status: "+h.status),n(h.status);n=null}},h.open("GET",c,!0),h.send()}))},t}(de),Nt=function(){function e(){this.rootNode_=st.EMPTY_NODE}return e.prototype.getNode=function(e){return this.rootNode_.getChild(e)},e.prototype.updateSnapshot=function(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)},e}();function Rt(){return{value:null,children:new Map}}function At(e,t,n){if(ke(t))e.value=n,e.children.clear();else if(null!==e.value)e.value=e.value.updateChild(t,n);else{var r=ye(t);e.children.has(r)||e.children.set(r,Rt()),At(e.children.get(r),t=me(t),n)}}function Dt(e,t){if(ke(t))return e.value=null,e.children.clear(),!0;if(null!==e.value){if(e.value.isLeafNode())return!1;var n=e.value;return e.value=null,n.forEachChild(tt,(function(t,n){At(e,new _e(t),n)})),Dt(e,t)}if(e.children.size>0){var r=ye(t);if(t=me(t),e.children.has(r))Dt(e.children.get(r),t)&&e.children.delete(r);return 0===e.children.size}return!0}function Ot(e,t,n){null!==e.value?n(t,e.value):function(e,t){e.children.forEach((function(e,n){t(n,e)}))}(e,(function(e,r){Ot(r,new _e(t.toString()+"/"+e),n)}))}var Mt,qt=function(){function e(e){this.collection_=e,this.last_=null}return e.prototype.get=function(){var e=this.collection_.get(),t=(0,a.__assign)({},e);return this.last_&&q(this.last_,(function(e,n){t[e]=t[e]-n})),this.last_=e,t},e}(),Ft=function(){function e(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new qt(e);var n=1e4+2e4*Math.random();V(this.reportStats_.bind(this),Math.floor(n))}return e.prototype.reportStats_=function(){var e=this,t=this.statsListener_.get(),n={},r=!1;q(t,(function(t,i){i>0&&(0,o.contains)(e.statsToReport_,t)&&(n[t]=i,r=!0)})),r&&this.server_.reportStats(n),V(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))},e}();function Lt(e){return{fromUser:!1,fromServer:!0,queryId:e,tagged:!0}}!function(e){e[e.OVERWRITE=0]="OVERWRITE",e[e.MERGE=1]="MERGE",e[e.ACK_USER_WRITE=2]="ACK_USER_WRITE",e[e.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"}(Mt||(Mt={}));var Wt,Ut=function(){function e(e,t,n){this.path=e,this.affectedTree=t,this.revert=n,this.type=Mt.ACK_USER_WRITE,this.source={fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}return e.prototype.operationForChild=function(t){if(ke(this.path)){if(null!=this.affectedTree.value)return(0,o.assert)(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;var n=this.affectedTree.subtree(new _e(t));return new e(ve(),n,this.revert)}return(0,o.assert)(ye(this.path)===t,"operationForChild called for unrelated child."),new e(me(this.path),this.affectedTree,this.revert)},e}(),jt=function(){function e(e,t){this.source=e,this.path=t,this.type=Mt.LISTEN_COMPLETE}return e.prototype.operationForChild=function(t){return ke(this.path)?new e(this.source,ve()):new e(this.source,me(this.path))},e}(),Bt=function(){function e(e,t,n){this.source=e,this.path=t,this.snap=n,this.type=Mt.OVERWRITE}return e.prototype.operationForChild=function(t){return ke(this.path)?new e(this.source,ve(),this.snap.getImmediateChild(t)):new e(this.source,me(this.path),this.snap)},e}(),Vt=function(){function e(e,t,n){this.source=e,this.path=t,this.children=n,this.type=Mt.MERGE}return e.prototype.operationForChild=function(t){if(ke(this.path)){var n=this.children.subtree(new _e(t));return n.isEmpty()?null:n.value?new Bt(this.source,ve(),n.value):new e(this.source,ve(),n)}return(0,o.assert)(ye(this.path)===t,"Can't get a merge for a child not on the path of the operation"),new e(this.source,me(this.path),this.children)},e.prototype.toString=function(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"},e}(),Qt=function(){function e(e,t,n){this.node_=e,this.fullyInitialized_=t,this.filtered_=n}return e.prototype.isFullyInitialized=function(){return this.fullyInitialized_},e.prototype.isFiltered=function(){return this.filtered_},e.prototype.isCompleteForPath=function(e){if(ke(e))return this.isFullyInitialized()&&!this.filtered_;var t=ye(e);return this.isCompleteForChild(t)},e.prototype.isCompleteForChild=function(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)},e.prototype.getNode=function(){return this.node_},e}(),Ht=function(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()};function zt(e,t,n,r,i,a){var s=r.filter((function(e){return e.type===n}));s.sort((function(t,n){return function(e,t,n){if(null==t.childName||null==n.childName)throw(0,o.assertionError)("Should only compare child_ events.");var r=new Fe(t.childName,t.snapshotNode),i=new Fe(n.childName,n.snapshotNode);return e.index_.compare(r,i)}(e,t,n)})),s.forEach((function(n){var r=function(e,t,n){return"value"===t.type||"child_removed"===t.type||(t.prevName=n.getPredecessorChildName(t.childName,t.snapshotNode,e.index_)),t}(e,n,a);i.forEach((function(i){i.respondsTo(n.type)&&t.push(i.createEvent(r,e.query_))}))}))}function Yt(e,t){return{eventCache:e,serverCache:t}}function Kt(e,t,n,r){return Yt(new Qt(t,n,r),e.serverCache)}function Gt(e,t,n,r){return Yt(e.eventCache,new Qt(t,n,r))}function $t(e){return e.eventCache.isFullyInitialized()?e.eventCache.getNode():null}function Jt(e){return e.serverCache.isFullyInitialized()?e.serverCache.getNode():null}var Xt=function(){function e(e,t){void 0===t&&(Wt||(Wt=new Qe(A)),t=Wt),this.value=e,this.children=t}return e.fromObject=function(t){var n=new e(null);return q(t,(function(e,t){n=n.set(new _e(e),t)})),n},e.prototype.isEmpty=function(){return null===this.value&&this.children.isEmpty()},e.prototype.findRootMostMatchingPathAndValue=function(e,t){if(null!=this.value&&t(this.value))return{path:ve(),value:this.value};if(ke(e))return null;var n=ye(e),r=this.children.get(n);if(null!==r){var i=r.findRootMostMatchingPathAndValue(me(e),t);return null!=i?{path:Te(new _e(n),i.path),value:i.value}:null}return null},e.prototype.findRootMostValueAndPath=function(e){return this.findRootMostMatchingPathAndValue(e,(function(){return!0}))},e.prototype.subtree=function(t){if(ke(t))return this;var n=ye(t),r=this.children.get(n);return null!==r?r.subtree(me(t)):new e(null)},e.prototype.set=function(t,n){if(ke(t))return new e(n,this.children);var r=ye(t),i=(this.children.get(r)||new e(null)).set(me(t),n),o=this.children.insert(r,i);return new e(this.value,o)},e.prototype.remove=function(t){if(ke(t))return this.children.isEmpty()?new e(null):new e(null,this.children);var n=ye(t),r=this.children.get(n);if(r){var i=r.remove(me(t)),o=void 0;return o=i.isEmpty()?this.children.remove(n):this.children.insert(n,i),null===this.value&&o.isEmpty()?new e(null):new e(this.value,o)}return this},e.prototype.get=function(e){if(ke(e))return this.value;var t=ye(e),n=this.children.get(t);return n?n.get(me(e)):null},e.prototype.setTree=function(t,n){if(ke(t))return n;var r=ye(t),i=(this.children.get(r)||new e(null)).setTree(me(t),n),o=void 0;return o=i.isEmpty()?this.children.remove(r):this.children.insert(r,i),new e(this.value,o)},e.prototype.fold=function(e){return this.fold_(ve(),e)},e.prototype.fold_=function(e,t){var n={};return this.children.inorderTraversal((function(r,i){n[r]=i.fold_(Te(e,r),t)})),t(e,this.value,n)},e.prototype.findOnPath=function(e,t){return this.findOnPath_(e,ve(),t)},e.prototype.findOnPath_=function(e,t,n){var r=!!this.value&&n(t,this.value);if(r)return r;if(ke(e))return null;var i=ye(e),o=this.children.get(i);return o?o.findOnPath_(me(e),Te(t,i),n):null},e.prototype.foreachOnPath=function(e,t){return this.foreachOnPath_(e,ve(),t)},e.prototype.foreachOnPath_=function(t,n,r){if(ke(t))return this;this.value&&r(n,this.value);var i=ye(t),o=this.children.get(i);return o?o.foreachOnPath_(me(t),Te(n,i),r):new e(null)},e.prototype.foreach=function(e){this.foreach_(ve(),e)},e.prototype.foreach_=function(e,t){this.children.inorderTraversal((function(n,r){r.foreach_(Te(e,n),t)})),this.value&&t(e,this.value)},e.prototype.foreachChild=function(e){this.children.inorderTraversal((function(t,n){n.value&&e(t,n.value)}))},e}(),Zt=function(){function e(e){this.writeTree_=e}return e.empty=function(){return new e(new Xt(null))},e}();function en(e,t,n){if(ke(t))return new Zt(new Xt(n));var r=e.writeTree_.findRootMostValueAndPath(t);if(null!=r){var i=r.path,o=r.value,a=Ie(i,t);return o=o.updateChild(a,n),new Zt(e.writeTree_.set(i,o))}var s=new Xt(n),u=e.writeTree_.setTree(t,s);return new Zt(u)}function tn(e,t,n){var r=e;return q(n,(function(e,n){r=en(r,Te(t,e),n)})),r}function nn(e,t){if(ke(t))return Zt.empty();var n=e.writeTree_.setTree(t,new Xt(null));return new Zt(n)}function rn(e,t){return null!=on(e,t)}function on(e,t){var n=e.writeTree_.findRootMostValueAndPath(t);return null!=n?e.writeTree_.get(n.path).getChild(Ie(n.path,t)):null}function an(e){var t=[],n=e.writeTree_.value;return null!=n?n.isLeafNode()||n.forEachChild(tt,(function(e,n){t.push(new Fe(e,n))})):e.writeTree_.children.inorderTraversal((function(e,n){null!=n.value&&t.push(new Fe(e,n.value))})),t}function sn(e,t){if(ke(t))return e;var n=on(e,t);return new Zt(null!=n?new Xt(n):e.writeTree_.subtree(t))}function un(e){return e.writeTree_.isEmpty()}function ln(e,t){return cn(ve(),e.writeTree_,t)}function cn(e,t,n){if(null!=t.value)return n.updateChild(e,t.value);var r=null;return t.children.inorderTraversal((function(t,i){".priority"===t?((0,o.assert)(null!==i.value,"Priority writes must always be leaf nodes"),r=i.value):n=cn(Te(e,t),i,n)})),n.getChild(e).isEmpty()||null===r||(n=n.updateChild(Te(e,".priority"),r)),n}function hn(e,t){return kn(t,e)}function dn(e,t){var n=e.allWrites.findIndex((function(e){return e.writeId===t}));(0,o.assert)(n>=0,"removeWrite called with nonexistent writeId.");var r=e.allWrites[n];e.allWrites.splice(n,1);for(var i=r.visible,a=!1,s=e.allWrites.length-1;i&&s>=0;){var u=e.allWrites[s];u.visible&&(s>=n&&pn(u,r.path)?i=!1:Pe(r.path,u.path)&&(a=!0)),s--}if(i){if(a)return function(e){e.visibleWrites=_n(e.allWrites,fn,ve()),e.allWrites.length>0?e.lastWriteId=e.allWrites[e.allWrites.length-1].writeId:e.lastWriteId=-1}(e),!0;r.snap?e.visibleWrites=nn(e.visibleWrites,r.path):q(r.children,(function(t){e.visibleWrites=nn(e.visibleWrites,Te(r.path,t))}));return!0}return!1}function pn(e,t){if(e.snap)return Pe(e.path,t);for(var n in e.children)if(e.children.hasOwnProperty(n)&&Pe(Te(e.path,n),t))return!0;return!1}function fn(e){return e.visible}function _n(e,t,n){for(var r=Zt.empty(),i=0;i<e.length;++i){var a=e[i];if(t(a)){var s=a.path,u=void 0;if(a.snap)Pe(n,s)?r=en(r,u=Ie(n,s),a.snap):Pe(s,n)&&(u=Ie(s,n),r=en(r,ve(),a.snap.getChild(u)));else{if(!a.children)throw(0,o.assertionError)("WriteRecord should have .snap or .children");if(Pe(n,s))r=tn(r,u=Ie(n,s),a.children);else if(Pe(s,n))if(ke(u=Ie(s,n)))r=tn(r,ve(),a.children);else{var l=(0,o.safeGet)(a.children,ye(u));if(l){var c=l.getChild(me(u));r=en(r,ve(),c)}}}}}return r}function vn(e,t,n,r,i){if(r||i){var o=sn(e.visibleWrites,t);if(!i&&un(o))return n;if(i||null!=n||rn(o,ve())){return ln(_n(e.allWrites,(function(e){return(e.visible||i)&&(!r||!~r.indexOf(e.writeId))&&(Pe(e.path,t)||Pe(t,e.path))}),t),n||st.EMPTY_NODE)}return null}var a=on(e.visibleWrites,t);if(null!=a)return a;var s=sn(e.visibleWrites,t);return un(s)?n:null!=n||rn(s,ve())?ln(s,n||st.EMPTY_NODE):null}function yn(e,t,n,r){return vn(e.writeTree,e.treePath,t,n,r)}function gn(e,t){return function(e,t,n){var r=st.EMPTY_NODE,i=on(e.visibleWrites,t);if(i)return i.isLeafNode()||i.forEachChild(tt,(function(e,t){r=r.updateImmediateChild(e,t)})),r;if(n){var o=sn(e.visibleWrites,t);return n.forEachChild(tt,(function(e,t){var n=ln(sn(o,new _e(e)),t);r=r.updateImmediateChild(e,n)})),an(o).forEach((function(e){r=r.updateImmediateChild(e.name,e.node)})),r}return an(sn(e.visibleWrites,t)).forEach((function(e){r=r.updateImmediateChild(e.name,e.node)})),r}(e.writeTree,e.treePath,t)}function mn(e,t,n,r){return function(e,t,n,r,i){(0,o.assert)(r||i,"Either existingEventSnap or existingServerSnap must exist");var a=Te(t,n);if(rn(e.visibleWrites,a))return null;var s=sn(e.visibleWrites,a);return un(s)?i.getChild(n):ln(s,i.getChild(n))}(e.writeTree,e.treePath,t,n,r)}function Cn(e,t){return function(e,t){return on(e.visibleWrites,t)}(e.writeTree,Te(e.treePath,t))}function wn(e,t,n,r,i,o){return function(e,t,n,r,i,o,a){var s,u=sn(e.visibleWrites,t),l=on(u,ve());if(null!=l)s=l;else{if(null==n)return[];s=ln(u,n)}if((s=s.withIndex(a)).isEmpty()||s.isLeafNode())return[];for(var c=[],h=a.getCompare(),d=o?s.getReverseIteratorFrom(r,a):s.getIteratorFrom(r,a),p=d.getNext();p&&c.length<i;)0!==h(p,r)&&c.push(p),p=d.getNext();return c}(e.writeTree,e.treePath,t,n,r,i,o)}function bn(e,t,n){return function(e,t,n,r){var i=Te(t,n),o=on(e.visibleWrites,i);return null!=o?o:r.isCompleteForChild(n)?ln(sn(e.visibleWrites,i),r.getNode().getImmediateChild(n)):null}(e.writeTree,e.treePath,t,n)}function Tn(e,t){return kn(Te(e.treePath,t),e.writeTree)}function kn(e,t){return{treePath:e,writeTree:t}}var In=function(){function e(){this.changeMap=new Map}return e.prototype.trackChildChange=function(e){var t=e.type,n=e.childName;(0,o.assert)("child_added"===t||"child_changed"===t||"child_removed"===t,"Only child changes supported for tracking"),(0,o.assert)(".priority"!==n,"Only non-priority child changes can be tracked.");var r=this.changeMap.get(n);if(r){var i=r.type;if("child_added"===t&&"child_removed"===i)this.changeMap.set(n,mt(n,e.snapshotNode,r.snapshotNode));else if("child_removed"===t&&"child_added"===i)this.changeMap.delete(n);else if("child_removed"===t&&"child_changed"===i)this.changeMap.set(n,gt(n,r.oldSnap));else if("child_changed"===t&&"child_added"===i)this.changeMap.set(n,yt(n,e.snapshotNode));else{if("child_changed"!==t||"child_changed"!==i)throw(0,o.assertionError)("Illegal combination of changes: "+e+" occurred after "+r);this.changeMap.set(n,mt(n,e.snapshotNode,r.oldSnap))}}else this.changeMap.set(n,e)},e.prototype.getChanges=function(){return Array.from(this.changeMap.values())},e}(),En=new(function(){function e(){}return e.prototype.getCompleteChild=function(e){return null},e.prototype.getChildAfterChild=function(e,t,n){return null},e}()),Sn=function(){function e(e,t,n){void 0===n&&(n=null),this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=n}return e.prototype.getCompleteChild=function(e){var t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);var n=null!=this.optCompleteServerCache_?new Qt(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return bn(this.writes_,e,n)},e.prototype.getChildAfterChild=function(e,t,n){var r=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:Jt(this.viewCache_),i=wn(this.writes_,r,t,1,n,e);return 0===i.length?null:i[0]},e}();function Pn(e,t,n,r,i){var a,s,u=new In;if(n.type===Mt.OVERWRITE){var l=n;l.source.fromUser?a=Rn(e,t,l.path,l.snap,r,i,u):((0,o.assert)(l.source.fromServer,"Unknown source."),s=l.source.tagged||t.serverCache.isFiltered()&&!ke(l.path),a=Nn(e,t,l.path,l.snap,r,i,s,u))}else if(n.type===Mt.MERGE){var c=n;c.source.fromUser?a=function(e,t,n,r,i,o,a){var s=t;return r.foreach((function(r,u){var l=Te(n,r);An(t,ye(l))&&(s=Rn(e,s,l,u,i,o,a))})),r.foreach((function(r,u){var l=Te(n,r);An(t,ye(l))||(s=Rn(e,s,l,u,i,o,a))})),s}(e,t,c.path,c.children,r,i,u):((0,o.assert)(c.source.fromServer,"Unknown source."),s=c.source.tagged||t.serverCache.isFiltered(),a=On(e,t,c.path,c.children,r,i,s,u))}else if(n.type===Mt.ACK_USER_WRITE){var h=n;a=h.revert?function(e,t,n,r,i,a){var s;if(null!=Cn(r,n))return t;var u=new Sn(r,t,i),l=t.eventCache.getNode(),c=void 0;if(ke(n)||".priority"===ye(n)){var h=void 0;if(t.serverCache.isFullyInitialized())h=yn(r,Jt(t));else{var d=t.serverCache.getNode();(0,o.assert)(d instanceof st,"serverChildren would be complete if leaf node"),h=gn(r,d)}h=h,c=e.filter.updateFullNode(l,h,a)}else{var p=ye(n),f=bn(r,p,t.serverCache);null==f&&t.serverCache.isCompleteForChild(p)&&(f=l.getImmediateChild(p)),(c=null!=f?e.filter.updateChild(l,p,f,me(n),u,a):t.eventCache.getNode().hasChild(p)?e.filter.updateChild(l,p,st.EMPTY_NODE,me(n),u,a):l).isEmpty()&&t.serverCache.isFullyInitialized()&&(s=yn(r,Jt(t))).isLeafNode()&&(c=e.filter.updateFullNode(c,s,a))}return s=t.serverCache.isFullyInitialized()||null!=Cn(r,ve()),Kt(t,c,s,e.filter.filtersNodes())}(e,t,h.path,r,i,u):function(e,t,n,r,i,o,a){if(null!=Cn(i,n))return t;var s=t.serverCache.isFiltered(),u=t.serverCache;if(null!=r.value){if(ke(n)&&u.isFullyInitialized()||u.isCompleteForPath(n))return Nn(e,t,n,u.getNode().getChild(n),i,o,s,a);if(ke(n)){var l=new Xt(null);return u.getNode().forEachChild(Ue,(function(e,t){l=l.set(new _e(e),t)})),On(e,t,n,l,i,o,s,a)}return t}var c=new Xt(null);return r.foreach((function(e,t){var r=Te(n,e);u.isCompleteForPath(r)&&(c=c.set(e,u.getNode().getChild(r)))})),On(e,t,n,c,i,o,s,a)}(e,t,h.path,h.affectedTree,r,i,u)}else{if(n.type!==Mt.LISTEN_COMPLETE)throw(0,o.assertionError)("Unknown operation type: "+n.type);a=function(e,t,n,r,i){var o=t.serverCache,a=Gt(t,o.getNode(),o.isFullyInitialized()||ke(n),o.isFiltered());return xn(e,a,n,r,En,i)}(e,t,n.path,r,u)}var d=u.getChanges();return function(e,t,n){var r=t.eventCache;if(r.isFullyInitialized()){var i=r.getNode().isLeafNode()||r.getNode().isEmpty(),o=$t(e);(n.length>0||!e.eventCache.isFullyInitialized()||i&&!r.getNode().equals(o)||!r.getNode().getPriority().equals(o.getPriority()))&&n.push(vt($t(t)))}}(t,a,d),{viewCache:a,changes:d}}function xn(e,t,n,r,i,a){var s=t.eventCache;if(null!=Cn(r,n))return t;var u=void 0,l=void 0;if(ke(n))if((0,o.assert)(t.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),t.serverCache.isFiltered()){var c=Jt(t),h=gn(r,c instanceof st?c:st.EMPTY_NODE);u=e.filter.updateFullNode(t.eventCache.getNode(),h,a)}else{var d=yn(r,Jt(t));u=e.filter.updateFullNode(t.eventCache.getNode(),d,a)}else{var p=ye(n);if(".priority"===p){(0,o.assert)(1===ge(n),"Can't have a priority with additional path components");var f=s.getNode(),_=mn(r,n,f,l=t.serverCache.getNode());u=null!=_?e.filter.updatePriority(f,_):s.getNode()}else{var v=me(n),y=void 0;if(s.isCompleteForChild(p)){l=t.serverCache.getNode();var g=mn(r,n,s.getNode(),l);y=null!=g?s.getNode().getImmediateChild(p).updateChild(v,g):s.getNode().getImmediateChild(p)}else y=bn(r,p,t.serverCache);u=null!=y?e.filter.updateChild(s.getNode(),p,y,v,i,a):s.getNode()}}return Kt(t,u,s.isFullyInitialized()||ke(n),e.filter.filtersNodes())}function Nn(e,t,n,r,i,o,a,s){var u,l=t.serverCache,c=a?e.filter:e.filter.getIndexedFilter();if(ke(n))u=c.updateFullNode(l.getNode(),r,null);else if(c.filtersNodes()&&!l.isFiltered()){var h=l.getNode().updateChild(n,r);u=c.updateFullNode(l.getNode(),h,null)}else{var d=ye(n);if(!l.isCompleteForPath(n)&&ge(n)>1)return t;var p=me(n),f=l.getNode().getImmediateChild(d).updateChild(p,r);u=".priority"===d?c.updatePriority(l.getNode(),f):c.updateChild(l.getNode(),d,f,p,En,null)}var _=Gt(t,u,l.isFullyInitialized()||ke(n),c.filtersNodes());return xn(e,_,n,i,new Sn(i,_,o),s)}function Rn(e,t,n,r,i,o,a){var s,u,l=t.eventCache,c=new Sn(i,t,o);if(ke(n))u=e.filter.updateFullNode(t.eventCache.getNode(),r,a),s=Kt(t,u,!0,e.filter.filtersNodes());else{var h=ye(n);if(".priority"===h)u=e.filter.updatePriority(t.eventCache.getNode(),r),s=Kt(t,u,l.isFullyInitialized(),l.isFiltered());else{var d=me(n),p=l.getNode().getImmediateChild(h),f=void 0;if(ke(d))f=r;else{var _=c.getCompleteChild(h);f=null!=_?".priority"===Ce(d)&&_.getChild(be(d)).isEmpty()?_:_.updateChild(d,r):st.EMPTY_NODE}if(p.equals(f))s=t;else s=Kt(t,e.filter.updateChild(l.getNode(),h,f,d,c,a),l.isFullyInitialized(),e.filter.filtersNodes())}}return s}function An(e,t){return e.eventCache.isCompleteForChild(t)}function Dn(e,t,n){return n.foreach((function(e,n){t=t.updateChild(e,n)})),t}function On(e,t,n,r,i,o,a,s){if(t.serverCache.getNode().isEmpty()&&!t.serverCache.isFullyInitialized())return t;var u,l=t;u=ke(n)?r:new Xt(null).setTree(n,r);var c=t.serverCache.getNode();return u.children.inorderTraversal((function(n,r){if(c.hasChild(n)){var u=Dn(0,t.serverCache.getNode().getImmediateChild(n),r);l=Nn(e,l,new _e(n),u,i,o,a,s)}})),u.children.inorderTraversal((function(n,r){var u=!t.serverCache.isCompleteForChild(n)&&void 0===r.value;if(!c.hasChild(n)&&!u){var h=Dn(0,t.serverCache.getNode().getImmediateChild(n),r);l=Nn(e,l,new _e(n),h,i,o,a,s)}})),l}var Mn,qn=function(){function e(e,t){this.query_=e,this.eventRegistrations_=[];var n,r=this.query_._queryParams,i=new Ct(r.getIndex()),o=(n=r).loadsAllData()?new Ct(n.getIndex()):n.hasLimit()?new bt(n):new wt(n);this.processor_=function(e){return{filter:e}}(o);var a=t.serverCache,s=t.eventCache,u=i.updateFullNode(st.EMPTY_NODE,a.getNode(),null),l=o.updateFullNode(st.EMPTY_NODE,s.getNode(),null),c=new Qt(u,a.isFullyInitialized(),i.filtersNodes()),h=new Qt(l,s.isFullyInitialized(),o.filtersNodes());this.viewCache_=Yt(h,c),this.eventGenerator_=new Ht(this.query_)}return Object.defineProperty(e.prototype,"query",{get:function(){return this.query_},enumerable:!1,configurable:!0}),e}();function Fn(e,t){var n=Jt(e.viewCache_);return n&&(e.query._queryParams.loadsAllData()||!ke(t)&&!n.getImmediateChild(ye(t)).isEmpty())?n.getChild(t):null}function Ln(e){return 0===e.eventRegistrations_.length}function Wn(e,t,n){var r=[];if(n){(0,o.assert)(null==t,"A cancel should cancel all event registrations.");var i=e.query._path;e.eventRegistrations_.forEach((function(e){var t=e.createCancelEvent(n,i);t&&r.push(t)}))}if(t){for(var a=[],s=0;s<e.eventRegistrations_.length;++s){var u=e.eventRegistrations_[s];if(u.matches(t)){if(t.hasAnyCallback()){a=a.concat(e.eventRegistrations_.slice(s+1));break}}else a.push(u)}e.eventRegistrations_=a}else e.eventRegistrations_=[];return r}function Un(e,t,n,r){t.type===Mt.MERGE&&null!==t.source.queryId&&((0,o.assert)(Jt(e.viewCache_),"We should always have a full cache before handling merges"),(0,o.assert)($t(e.viewCache_),"Missing event cache, even though we have a server cache"));var i,a,s=e.viewCache_,u=Pn(e.processor_,s,t,n,r);return i=e.processor_,a=u.viewCache,(0,o.assert)(a.eventCache.getNode().isIndexed(i.filter.getIndex()),"Event snap not indexed"),(0,o.assert)(a.serverCache.getNode().isIndexed(i.filter.getIndex()),"Server snap not indexed"),(0,o.assert)(u.viewCache.serverCache.isFullyInitialized()||!s.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),e.viewCache_=u.viewCache,jn(e,u.changes,u.viewCache.eventCache.getNode(),null)}function jn(e,t,n,r){var i=r?[r]:e.eventRegistrations_;return function(e,t,n,r){var i=[],o=[];return t.forEach((function(t){var n;"child_changed"===t.type&&e.index_.indexedValueChanged(t.oldSnap,t.snapshotNode)&&o.push((n=t.childName,{type:"child_moved",snapshotNode:t.snapshotNode,childName:n}))})),zt(e,i,"child_removed",t,r,n),zt(e,i,"child_added",t,r,n),zt(e,i,"child_moved",o,r,n),zt(e,i,"child_changed",t,r,n),zt(e,i,"value",t,r,n),i}(e.eventGenerator_,t,n,i)}var Bn,Vn=function(){this.views=new Map};function Qn(e,t,n,r){var i,s,u=t.source.queryId;if(null!==u){var l=e.views.get(u);return(0,o.assert)(null!=l,"SyncTree gave us an op for an invalid query."),Un(l,t,n,r)}var c=[];try{for(var h=(0,a.__values)(e.views.values()),d=h.next();!d.done;d=h.next()){l=d.value;c=c.concat(Un(l,t,n,r))}}catch(p){i={error:p}}finally{try{d&&!d.done&&(s=h.return)&&s.call(h)}finally{if(i)throw i.error}}return c}function Hn(e,t,n,r,i){var o=t._queryIdentifier,a=e.views.get(o);if(!a){var s=yn(n,i?r:null),u=!1;s?u=!0:r instanceof st?(s=gn(n,r),u=!1):(s=st.EMPTY_NODE,u=!1);var l=Yt(new Qt(s,u,!1),new Qt(r,i,!1));return new qn(t,l)}return a}function zn(e,t,n,r,i,o){var a=Hn(e,t,r,i,o);return e.views.has(t._queryIdentifier)||e.views.set(t._queryIdentifier,a),function(e,t){e.eventRegistrations_.push(t)}(a,n),function(e,t){var n=e.viewCache_.eventCache,r=[];return n.getNode().isLeafNode()||n.getNode().forEachChild(tt,(function(e,t){r.push(yt(e,t))})),n.isFullyInitialized()&&r.push(vt(n.getNode())),jn(e,r,n.getNode(),t)}(a,n)}function Yn(e,t,n,r){var i,s,u=t._queryIdentifier,l=[],c=[],h=Xn(e);if("default"===u)try{for(var d=(0,a.__values)(e.views.entries()),p=d.next();!p.done;p=d.next()){var f=(0,a.__read)(p.value,2),_=f[0],v=f[1];c=c.concat(Wn(v,n,r)),Ln(v)&&(e.views.delete(_),v.query._queryParams.loadsAllData()||l.push(v.query))}}catch(y){i={error:y}}finally{try{p&&!p.done&&(s=d.return)&&s.call(d)}finally{if(i)throw i.error}}else(v=e.views.get(u))&&(c=c.concat(Wn(v,n,r)),Ln(v)&&(e.views.delete(u),v.query._queryParams.loadsAllData()||l.push(v.query)));return h&&!Xn(e)&&l.push(new((0,o.assert)(Mn,"Reference.ts has not been loaded"),Mn)(t._repo,t._path)),{removed:l,events:c}}function Kn(e){var t,n,r=[];try{for(var i=(0,a.__values)(e.views.values()),o=i.next();!o.done;o=i.next()){var s=o.value;s.query._queryParams.loadsAllData()||r.push(s)}}catch(u){t={error:u}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return r}function Gn(e,t){var n,r,i=null;try{for(var o=(0,a.__values)(e.views.values()),s=o.next();!s.done;s=o.next()){var u=s.value;i=i||Fn(u,t)}}catch(l){n={error:l}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return i}function $n(e,t){if(t._queryParams.loadsAllData())return Zn(e);var n=t._queryIdentifier;return e.views.get(n)}function Jn(e,t){return null!=$n(e,t)}function Xn(e){return null!=Zn(e)}function Zn(e){var t,n;try{for(var r=(0,a.__values)(e.views.values()),i=r.next();!i.done;i=r.next()){var o=i.value;if(o.query._queryParams.loadsAllData())return o}}catch(s){t={error:s}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return null}var er=1,tr=function(e){this.listenProvider_=e,this.syncPointTree_=new Xt(null),this.pendingWriteTree_={visibleWrites:Zt.empty(),allWrites:[],lastWriteId:-1},this.tagToQueryMap=new Map,this.queryToTagMap=new Map};function nr(e,t,n,r,i){return function(e,t,n,r,i){(0,o.assert)(r>e.lastWriteId,"Stacking an older write on top of newer ones"),void 0===i&&(i=!0),e.allWrites.push({path:t,snap:n,writeId:r,visible:i}),i&&(e.visibleWrites=en(e.visibleWrites,t,n)),e.lastWriteId=r}(e.pendingWriteTree_,t,n,r,i),i?cr(e,new Bt({fromUser:!0,fromServer:!1,queryId:null,tagged:!1},t,n)):[]}function rr(e,t,n,r){!function(e,t,n,r){(0,o.assert)(r>e.lastWriteId,"Stacking an older merge on top of newer ones"),e.allWrites.push({path:t,children:n,writeId:r,visible:!0}),e.visibleWrites=tn(e.visibleWrites,t,n),e.lastWriteId=r}(e.pendingWriteTree_,t,n,r);var i=Xt.fromObject(n);return cr(e,new Vt({fromUser:!0,fromServer:!1,queryId:null,tagged:!1},t,i))}function ir(e,t,n){void 0===n&&(n=!1);var r=function(e,t){for(var n=0;n<e.allWrites.length;n++){var r=e.allWrites[n];if(r.writeId===t)return r}return null}(e.pendingWriteTree_,t);if(dn(e.pendingWriteTree_,t)){var i=new Xt(null);return null!=r.snap?i=i.set(ve(),!0):q(r.children,(function(e){i=i.set(new _e(e),!0)})),cr(e,new Ut(r.path,i,n))}return[]}function or(e,t,n){return cr(e,new Bt({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},t,n))}function ar(e,t,n,r){var i=t._path,o=e.syncPointTree_.get(i),a=[];if(o&&("default"===t._queryIdentifier||Jn(o,t))){var s=Yn(o,t,n,r);0===o.views.size&&(e.syncPointTree_=e.syncPointTree_.remove(i));var u=s.removed;a=s.events;var l=-1!==u.findIndex((function(e){return e._queryParams.loadsAllData()})),c=e.syncPointTree_.findOnPath(i,(function(e,t){return Xn(t)}));if(l&&!c){var h=e.syncPointTree_.subtree(i);if(!h.isEmpty())for(var d=function(e){return e.fold((function(e,t,n){if(t&&Xn(t))return[Zn(t)];var r=[];return t&&(r=Kn(t)),q(n,(function(e,t){r=r.concat(t)})),r}))}(h),p=0;p<d.length;++p){var f=d[p],_=f.query,v=pr(e,f);e.listenProvider_.startListening(mr(_),fr(e,_),v.hashFn,v.onComplete)}}if(!c&&u.length>0&&!r)if(l){e.listenProvider_.stopListening(mr(t),null)}else u.forEach((function(t){var n=e.queryToTagMap.get(_r(t));e.listenProvider_.stopListening(mr(t),n)}));!function(e,t){for(var n=0;n<t.length;++n){var r=t[n];if(!r._queryParams.loadsAllData()){var i=_r(r),o=e.queryToTagMap.get(i);e.queryToTagMap.delete(i),e.tagToQueryMap.delete(o)}}}(e,u)}return a}function sr(e,t,n){var r=t._path,i=null,a=!1;e.syncPointTree_.foreachOnPath(r,(function(e,t){var n=Ie(e,r);i=i||Gn(t,n),a=a||Xn(t)}));var s,u=e.syncPointTree_.get(r);(u?(a=a||Xn(u),i=i||Gn(u,ve())):(u=new Vn,e.syncPointTree_=e.syncPointTree_.set(r,u)),null!=i)?s=!0:(s=!1,i=st.EMPTY_NODE,e.syncPointTree_.subtree(r).foreachChild((function(e,t){var n=Gn(t,ve());n&&(i=i.updateImmediateChild(e,n))})));var l=Jn(u,t);if(!l&&!t._queryParams.loadsAllData()){var c=_r(t);(0,o.assert)(!e.queryToTagMap.has(c),"View does not exist, but we have a tag");var h=er++;e.queryToTagMap.set(c,h),e.tagToQueryMap.set(h,c)}var d=zn(u,t,n,hn(e.pendingWriteTree_,r),i,s);if(!l&&!a){var p=$n(u,t);d=d.concat(function(e,t,n){var r=t._path,i=fr(e,t),a=pr(e,n),s=e.listenProvider_.startListening(mr(t),i,a.hashFn,a.onComplete),u=e.syncPointTree_.subtree(r);if(i)(0,o.assert)(!Xn(u.value),"If we're adding a query, it shouldn't be shadowed");else for(var l=u.fold((function(e,t,n){if(!ke(e)&&t&&Xn(t))return[Zn(t).query];var r=[];return t&&(r=r.concat(Kn(t).map((function(e){return e.query})))),q(n,(function(e,t){r=r.concat(t)})),r})),c=0;c<l.length;++c){var h=l[c];e.listenProvider_.stopListening(mr(h),fr(e,h))}return s}(e,t,p))}return d}function ur(e,t,n){var r=e.pendingWriteTree_,i=e.syncPointTree_.findOnPath(t,(function(e,n){var r=Gn(n,Ie(e,t));if(r)return r}));return vn(r,t,i,n,!0)}function lr(e,t){var n=t._path,r=null;e.syncPointTree_.foreachOnPath(n,(function(e,t){var i=Ie(e,n);r=r||Gn(t,i)}));var i=e.syncPointTree_.get(n);i?r=r||Gn(i,ve()):(i=new Vn,e.syncPointTree_=e.syncPointTree_.set(n,i));var o=null!=r,a=o?new Qt(r,!0,!1):null;return function(e){return $t(e.viewCache_)}(Hn(i,t,hn(e.pendingWriteTree_,t._path),o?a.getNode():st.EMPTY_NODE,o))}function cr(e,t){return hr(t,e.syncPointTree_,null,hn(e.pendingWriteTree_,ve()))}function hr(e,t,n,r){if(ke(e.path))return dr(e,t,n,r);var i=t.get(ve());null==n&&null!=i&&(n=Gn(i,ve()));var o=[],a=ye(e.path),s=e.operationForChild(a),u=t.children.get(a);if(u&&s){var l=n?n.getImmediateChild(a):null,c=Tn(r,a);o=o.concat(hr(s,u,l,c))}return i&&(o=o.concat(Qn(i,e,r,n))),o}function dr(e,t,n,r){var i=t.get(ve());null==n&&null!=i&&(n=Gn(i,ve()));var o=[];return t.children.inorderTraversal((function(t,i){var a=n?n.getImmediateChild(t):null,s=Tn(r,t),u=e.operationForChild(t);u&&(o=o.concat(dr(u,i,a,s)))})),i&&(o=o.concat(Qn(i,e,r,n))),o}function pr(e,t){var n=t.query,r=fr(e,n);return{hashFn:function(){return(function(e){return e.viewCache_.serverCache.getNode()}(t)||st.EMPTY_NODE).hash()},onComplete:function(t){if("ok"===t)return r?function(e,t,n){var r=vr(e,n);if(r){var i=yr(r),o=i.path,a=i.queryId,s=Ie(o,t);return gr(e,o,new jt(Lt(a),s))}return[]}(e,n._path,r):function(e,t){return cr(e,new jt({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},t))}(e,n._path);var i=function(e,t){var n="Unknown Error";"too_big"===e?n="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===e?n="Client doesn't have permission to access the desired data.":"unavailable"===e&&(n="The service is unavailable");var r=new Error(e+" at "+t._path.toString()+": "+n);return r.code=e.toUpperCase(),r}(t,n);return ar(e,n,null,i)}}}function fr(e,t){var n=_r(t);return e.queryToTagMap.get(n)}function _r(e){return e._path.toString()+"$"+e._queryIdentifier}function vr(e,t){return e.tagToQueryMap.get(t)}function yr(e){var t=e.indexOf("$");return(0,o.assert)(-1!==t&&t<e.length-1,"Bad queryKey."),{queryId:e.substr(t+1),path:new _e(e.substr(0,t))}}function gr(e,t,n){var r=e.syncPointTree_.get(t);return(0,o.assert)(r,"Missing sync point for query tag that we're tracking"),Qn(r,n,hn(e.pendingWriteTree_,t),null)}function mr(e){return e._queryParams.loadsAllData()&&!e._queryParams.isDefault()?new((0,o.assert)(Bn,"Reference.ts has not been loaded"),Bn)(e._repo,e._path):e}var Cr=function(){function e(e){this.node_=e}return e.prototype.getImmediateChild=function(t){return new e(this.node_.getImmediateChild(t))},e.prototype.node=function(){return this.node_},e}(),wr=function(){function e(e,t){this.syncTree_=e,this.path_=t}return e.prototype.getImmediateChild=function(t){var n=Te(this.path_,t);return new e(this.syncTree_,n)},e.prototype.node=function(){return ur(this.syncTree_,this.path_)},e}(),br=function(e,t,n){return e&&"object"===typeof e?((0,o.assert)(".sv"in e,"Unexpected leaf node or priority contents"),"string"===typeof e[".sv"]?Tr(e[".sv"],t,n):"object"===typeof e[".sv"]?kr(e[".sv"],t):void(0,o.assert)(!1,"Unexpected server value: "+JSON.stringify(e,null,2))):e},Tr=function(e,t,n){switch(e){case"timestamp":return n.timestamp;default:(0,o.assert)(!1,"Unexpected server value: "+e)}},kr=function(e,t,n){e.hasOwnProperty("increment")||(0,o.assert)(!1,"Unexpected server value: "+JSON.stringify(e,null,2));var r=e.increment;"number"!==typeof r&&(0,o.assert)(!1,"Unexpected increment value: "+r);var i=t.node();if((0,o.assert)(null!==i&&"undefined"!==typeof i,"Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return r;var a=i.getValue();return"number"!==typeof a?r:a+r},Ir=function(e,t,n,r){return Sr(t,new wr(n,e),r)},Er=function(e,t,n){return Sr(e,new Cr(t),n)};function Sr(e,t,n){var r,i=e.getPriority().val(),o=br(i,t.getImmediateChild(".priority"),n);if(e.isLeafNode()){var a=e,s=br(a.getValue(),t,n);return s!==a.getValue()||o!==a.getPriority().val()?new Xe(s,lt(o)):e}var u=e;return r=u,o!==u.getPriority().val()&&(r=r.updatePriority(new Xe(o))),u.forEachChild(tt,(function(e,i){var o=Sr(i,t.getImmediateChild(e),n);o!==i&&(r=r.updateImmediateChild(e,o))})),r}var Pr=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t=null),void 0===n&&(n={children:{},childCount:0}),this.name=e,this.parent=t,this.node=n};function xr(e,t){for(var n=t instanceof _e?t:new _e(t),r=e,i=ye(n);null!==i;){var a=(0,o.safeGet)(r.node.children,i)||{children:{},childCount:0};r=new Pr(i,r,a),i=ye(n=me(n))}return r}function Nr(e){return e.node.value}function Rr(e,t){e.node.value=t,qr(e)}function Ar(e){return e.node.childCount>0}function Dr(e,t){q(e.node.children,(function(n,r){t(new Pr(n,e,r))}))}function Or(e,t,n,r){n&&!r&&t(e),Dr(e,(function(e){Or(e,t,!0,r)})),n&&r&&t(e)}function Mr(e){return new _e(null===e.parent?e.name:Mr(e.parent)+"/"+e.name)}function qr(e){null!==e.parent&&function(e,t,n){var r=function(e){return void 0===Nr(e)&&!Ar(e)}(n),i=(0,o.contains)(e.node.children,t);r&&i?(delete e.node.children[t],e.node.childCount--,qr(e)):r||i||(e.node.children[t]=n.node,e.node.childCount++,qr(e))}(e.parent,e.name,e)}var Fr=/[\[\].#$\/\u0000-\u001F\u007F]/,Lr=/[\[\].#$\u0000-\u001F\u007F]/,Wr=10485760,Ur=function(e){return"string"===typeof e&&0!==e.length&&!Fr.test(e)},jr=function(e){return"string"===typeof e&&0!==e.length&&!Lr.test(e)},Br=function(e){return null===e||"string"===typeof e||"number"===typeof e&&!P(e)||e&&"object"===typeof e&&(0,o.contains)(e,".sv")},Vr=function(e,t,n,r){r&&void 0===t||Qr((0,o.errorPrefix)(e,"value"),t,n)},Qr=function(e,t,n){var r=n instanceof _e?new xe(n,e):n;if(void 0===t)throw new Error(e+"contains undefined "+Re(r));if("function"===typeof t)throw new Error(e+"contains a function "+Re(r)+" with contents = "+t.toString());if(P(t))throw new Error(e+"contains "+t.toString()+" "+Re(r));if("string"===typeof t&&t.length>Wr/3&&(0,o.stringLength)(t)>Wr)throw new Error(e+"contains a string greater than "+"10485760 utf8 bytes "+Re(r)+" ('"+t.substring(0,50)+"...')");if(t&&"object"===typeof t){var i=!1,a=!1;if(q(t,(function(t,n){if(".value"===t)i=!0;else if(".priority"!==t&&".sv"!==t&&(a=!0,!Ur(t)))throw new Error(e+" contains an invalid key ("+t+") "+Re(r)+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');!function(e,t){e.parts_.length>0&&(e.byteLength_+=1),e.parts_.push(t),e.byteLength_+=(0,o.stringLength)(t),Ne(e)}(r,t),Qr(e,n,r),function(e){var t=e.parts_.pop();e.byteLength_-=(0,o.stringLength)(t),e.parts_.length>0&&(e.byteLength_-=1)}(r)})),i&&a)throw new Error(e+' contains ".value" child '+Re(r)+" in addition to actual children.")}},Hr=function(e,t,n,r){if(!r||void 0!==t){var i=(0,o.errorPrefix)(e,"values");if(!t||"object"!==typeof t||Array.isArray(t))throw new Error(i+" must be an object containing the children to replace.");var a=[];q(t,(function(e,t){var r=new _e(e);if(Qr(i,t,Te(n,r)),".priority"===Ce(r)&&!Br(t))throw new Error(i+"contains an invalid value for '"+r.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");a.push(r)})),function(e,t){var n,r;for(n=0;n<t.length;n++)for(var i=we(r=t[n]),o=0;o<i.length;o++)if(".priority"===i[o]&&o===i.length-1);else if(!Ur(i[o]))throw new Error(e+"contains an invalid key ("+i[o]+") in path "+r.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');t.sort(Ee);var a=null;for(n=0;n<t.length;n++){if(r=t[n],null!==a&&Pe(a,r))throw new Error(e+"contains a path "+a.toString()+" that is ancestor of another path "+r.toString());a=r}}(i,a)}},zr=function(e,t,n){if(!n||void 0!==t){if(P(t))throw new Error((0,o.errorPrefix)(e,"priority")+"is "+t.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Br(t))throw new Error((0,o.errorPrefix)(e,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},Yr=function(e,t,n){if(!n||void 0!==t)switch(t){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error((0,o.errorPrefix)(e,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}},Kr=function(e,t,n,r){if((!r||void 0!==n)&&!Ur(n))throw new Error((0,o.errorPrefix)(e,t)+'was an invalid key = "'+n+'".  Firebase keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]").')},Gr=function(e,t,n,r){if((!r||void 0!==n)&&!jr(n))throw new Error((0,o.errorPrefix)(e,t)+'was an invalid path = "'+n+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')},$r=function(e,t){if(".info"===ye(t))throw new Error(e+" failed = Can't modify data under /.info/")},Jr=function(e,t){var n=t.path.toString();if("string"!==typeof t.repoInfo.host||0===t.repoInfo.host.length||!Ur(t.repoInfo.namespace)&&"localhost"!==t.repoInfo.host.split(":")[0]||0!==n.length&&!function(e){return e&&(e=e.replace(/^\/*\.info(\/|$)/,"/")),jr(e)}(n))throw new Error((0,o.errorPrefix)(e,"url")+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')},Xr=function(e,t,n,r){if((!r||void 0!==n)&&"boolean"!==typeof n)throw new Error((0,o.errorPrefix)(e,t)+"must be a boolean.")},Zr=function(){this.eventLists_=[],this.recursionDepth_=0};function ei(e,t){for(var n=null,r=0;r<t.length;r++){var i=t[r],o=i.getPath();null===n||Se(o,n.path)||(e.eventLists_.push(n),n=null),null===n&&(n={events:[],path:o}),n.events.push(i)}n&&e.eventLists_.push(n)}function ti(e,t,n){ei(e,n),ri(e,(function(e){return Se(e,t)}))}function ni(e,t,n){ei(e,n),ri(e,(function(e){return Pe(e,t)||Pe(t,e)}))}function ri(e,t){e.recursionDepth_++;for(var n=!0,r=0;r<e.eventLists_.length;r++){var i=e.eventLists_[r];if(i)t(i.path)?(ii(e.eventLists_[r]),e.eventLists_[r]=null):n=!1}n&&(e.eventLists_=[]),e.recursionDepth_--}function ii(e){for(var t=0;t<e.events.length;t++){var n=e.events[t];if(null!==n){e.events[t]=null;var r=n.getEventRunner();C&&T("event: "+n.toString()),B(r)}}}var oi="repo_interrupt",ai=function(){function e(e,t,n,r){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=n,this.appCheckProvider_=r,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Zr,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Rt(),this.transactionQueueTree_=new Pr,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}return e.prototype.toString=function(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host},e}();function si(e,t,n){if(e.stats_=ne(e.repoInfo_),e.forceRestClient_||("object"===typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0)e.server_=new xt(e.repoInfo_,(function(t,n,r,i){ci(e,t,n,r,i)}),e.authTokenProvider_,e.appCheckProvider_),setTimeout((function(){return hi(e,!0)}),0);else{if("undefined"!==typeof n&&null!==n){if("object"!==typeof n)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{(0,o.stringify)(n)}catch(r){throw new Error("Invalid authOverride provided: "+r)}}e.persistentConnection_=new qe(e.repoInfo_,t,(function(t,n,r,i){ci(e,t,n,r,i)}),(function(t){hi(e,t)}),(function(t){!function(e,t){q(t,(function(t,n){di(e,t,n)}))}(e,t)}),e.authTokenProvider_,e.appCheckProvider_,n),e.server_=e.persistentConnection_}e.authTokenProvider_.addTokenChangeListener((function(t){e.server_.refreshAuthToken(t)})),e.appCheckProvider_.addTokenChangeListener((function(t){e.server_.refreshAppCheckToken(t.token)})),e.statsReporter_=function(e,t){var n=e.toString();return te[n]||(te[n]=t()),te[n]}(e.repoInfo_,(function(){return new Ft(e.stats_,e.server_)})),e.infoData_=new Nt,e.infoSyncTree_=new tr({startListening:function(t,n,r,i){var o=[],a=e.infoData_.getNode(t._path);return a.isEmpty()||(o=or(e.infoSyncTree_,t._path,a),setTimeout((function(){i("ok")}),0)),o},stopListening:function(){}}),di(e,"connected",!1),e.serverSyncTree_=new tr({startListening:function(t,n,r,i){return e.server_.listen(t,r,n,(function(n,r){var o=i(n,r);ni(e.eventQueue_,t._path,o)})),[]},stopListening:function(t,n){e.server_.unlisten(t,n)}})}function ui(e){var t=e.infoData_.getNode(new _e(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+t}function li(e){return(t=(t={timestamp:ui(e)})||{}).timestamp=t.timestamp||(new Date).getTime(),t;var t}function ci(e,t,n,r,i){e.dataUpdateCount++;var a=new _e(t);n=e.interceptServerDataCallback_?e.interceptServerDataCallback_(t,n):n;var s=[];if(i)if(r){var u=(0,o.map)(n,(function(e){return lt(e)}));s=function(e,t,n,r){var i=vr(e,r);if(i){var o=yr(i),a=o.path,s=o.queryId,u=Ie(a,t),l=Xt.fromObject(n);return gr(e,a,new Vt(Lt(s),u,l))}return[]}(e.serverSyncTree_,a,u,i)}else{var l=lt(n);s=function(e,t,n,r){var i=vr(e,r);if(null!=i){var o=yr(i),a=o.path,s=o.queryId,u=Ie(a,t);return gr(e,a,new Bt(Lt(s),u,n))}return[]}(e.serverSyncTree_,a,l,i)}else if(r){var c=(0,o.map)(n,(function(e){return lt(e)}));s=function(e,t,n){var r=Xt.fromObject(n);return cr(e,new Vt({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},t,r))}(e.serverSyncTree_,a,c)}else{var h=lt(n);s=or(e.serverSyncTree_,a,h)}var d=a;s.length>0&&(d=Ti(e,a)),ni(e.eventQueue_,d,s)}function hi(e,t){di(e,"connected",t),!1===t&&function(e){mi(e,"onDisconnectEvents");var t=li(e),n=Rt();Ot(e.onDisconnect_,ve(),(function(r,i){var o=Ir(r,i,e.serverSyncTree_,t);At(n,r,o)}));var r=[];Ot(n,ve(),(function(t,n){r=r.concat(or(e.serverSyncTree_,t,n));var i=Pi(e,t);Ti(e,i)})),e.onDisconnect_=Rt(),ni(e.eventQueue_,ve(),r)}(e)}function di(e,t,n){var r=new _e("/.info/"+t),i=lt(n);e.infoData_.updateSnapshot(r,i);var o=or(e.infoSyncTree_,r,i);ni(e.eventQueue_,r,o)}function pi(e){return e.nextWriteId_++}function fi(e,t,n,r,i){mi(e,"set",{path:t.toString(),value:n,priority:r});var o=li(e),a=lt(n,r),s=ur(e.serverSyncTree_,t),u=Er(a,s,o),l=pi(e),c=nr(e.serverSyncTree_,t,u,l,!0);ei(e.eventQueue_,c),e.server_.put(t.toString(),a.val(!0),(function(n,r){var o="ok"===n;o||S("set at "+t+" failed: "+n);var a=ir(e.serverSyncTree_,l,!o);ni(e.eventQueue_,t,a),Ci(e,i,n,r)}));var h=Pi(e,t);Ti(e,h),ni(e.eventQueue_,h,[])}function _i(e,t,n){e.server_.onDisconnectCancel(t.toString(),(function(r,i){"ok"===r&&Dt(e.onDisconnect_,t),Ci(e,n,r,i)}))}function vi(e,t,n,r){var i=lt(n);e.server_.onDisconnectPut(t.toString(),i.val(!0),(function(n,o){"ok"===n&&At(e.onDisconnect_,t,i),Ci(e,r,n,o)}))}function yi(e,t,n){var r;r=".info"===ye(t._path)?ar(e.infoSyncTree_,t,n):ar(e.serverSyncTree_,t,n),ti(e.eventQueue_,t._path,r)}function gi(e){e.persistentConnection_&&e.persistentConnection_.interrupt(oi)}function mi(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r="";e.persistentConnection_&&(r=e.persistentConnection_.id+":"),T.apply(void 0,(0,a.__spreadArray)([r],(0,a.__read)(t)))}function Ci(e,t,n,r){t&&B((function(){if("ok"===n)t(null);else{var e=(n||"error").toUpperCase(),i=e;r&&(i+=": "+r);var o=new Error(i);o.code=e,t(o)}}))}function wi(e,t,n){return ur(e.serverSyncTree_,t,n)||st.EMPTY_NODE}function bi(e,t){if(void 0===t&&(t=e.transactionQueueTree_),t||Si(e,t),Nr(t)){var n=Ii(e,t);(0,o.assert)(n.length>0,"Sending zero length transaction queue"),n.every((function(e){return 0===e.status}))&&function(e,t,n){for(var r=n.map((function(e){return e.currentWriteId})),i=wi(e,t,r),a=i,s=i.hash(),u=0;u<n.length;u++){var l=n[u];(0,o.assert)(0===l.status,"tryToSendTransactionQueue_: items in queue should all be run."),l.status=1,l.retryCount++;var c=Ie(t,l.path);a=a.updateChild(c,l.currentOutputSnapshotRaw)}var h=a.val(!0),d=t;e.server_.put(d.toString(),h,(function(r){mi(e,"transaction put response",{path:d.toString(),status:r});var i=[];if("ok"===r){for(var o=[],a=function(t){n[t].status=2,i=i.concat(ir(e.serverSyncTree_,n[t].currentWriteId)),n[t].onComplete&&o.push((function(){return n[t].onComplete(null,!0,n[t].currentOutputSnapshotResolved)})),n[t].unwatcher()},s=0;s<n.length;s++)a(s);Si(e,xr(e.transactionQueueTree_,t)),bi(e,e.transactionQueueTree_),ni(e.eventQueue_,t,i);for(s=0;s<o.length;s++)B(o[s])}else{if("datastale"===r)for(s=0;s<n.length;s++)3===n[s].status?n[s].status=4:n[s].status=0;else{S("transaction at "+d.toString()+" failed: "+r);for(s=0;s<n.length;s++)n[s].status=4,n[s].abortReason=r}Ti(e,t)}}),s)}(e,Mr(t),n)}else Ar(t)&&Dr(t,(function(t){bi(e,t)}))}function Ti(e,t){var n=ki(e,t),r=Mr(n);return function(e,t,n){if(0===t.length)return;for(var r=[],i=[],a=t.filter((function(e){return 0===e.status})).map((function(e){return e.currentWriteId})),s=function(s){var u,l,c=t[s],h=Ie(n,c.path),d=!1;if((0,o.assert)(null!==h,"rerunTransactionsUnderNode_: relativePath should not be null."),4===c.status)d=!0,u=c.abortReason,i=i.concat(ir(e.serverSyncTree_,c.currentWriteId,!0));else if(0===c.status)if(c.retryCount>=25)d=!0,u="maxretry",i=i.concat(ir(e.serverSyncTree_,c.currentWriteId,!0));else{var p=wi(e,c.path,a);c.currentInputSnapshot=p;var f=t[s].update(p.val());if(void 0!==f){Qr("transaction failed: Data returned ",f,c.path);var _=lt(f);"object"===typeof f&&null!=f&&(0,o.contains)(f,".priority")||(_=_.updatePriority(p.getPriority()));var v=c.currentWriteId,y=li(e),g=Er(_,p,y);c.currentOutputSnapshotRaw=_,c.currentOutputSnapshotResolved=g,c.currentWriteId=pi(e),a.splice(a.indexOf(v),1),i=(i=i.concat(nr(e.serverSyncTree_,c.path,g,c.currentWriteId,c.applyLocally))).concat(ir(e.serverSyncTree_,v,!0))}else d=!0,u="nodata",i=i.concat(ir(e.serverSyncTree_,c.currentWriteId,!0))}ni(e.eventQueue_,n,i),i=[],d&&(t[s].status=2,l=t[s].unwatcher,setTimeout(l,Math.floor(0)),t[s].onComplete&&("nodata"===u?r.push((function(){return t[s].onComplete(null,!1,t[s].currentInputSnapshot)})):r.push((function(){return t[s].onComplete(new Error(u),!1,null)}))))},u=0;u<t.length;u++)s(u);Si(e,e.transactionQueueTree_);for(u=0;u<r.length;u++)B(r[u]);bi(e,e.transactionQueueTree_)}(e,Ii(e,n),r),r}function ki(e,t){var n,r=e.transactionQueueTree_;for(n=ye(t);null!==n&&void 0===Nr(r);)r=xr(r,n),n=ye(t=me(t));return r}function Ii(e,t){var n=[];return Ei(e,t,n),n.sort((function(e,t){return e.order-t.order})),n}function Ei(e,t,n){var r=Nr(t);if(r)for(var i=0;i<r.length;i++)n.push(r[i]);Dr(t,(function(t){Ei(e,t,n)}))}function Si(e,t){var n=Nr(t);if(n){for(var r=0,i=0;i<n.length;i++)2!==n[i].status&&(n[r]=n[i],r++);n.length=r,Rr(t,n.length>0?n:void 0)}Dr(t,(function(t){Si(e,t)}))}function Pi(e,t){var n=Mr(ki(e,t)),r=xr(e.transactionQueueTree_,t);return function(e,t,n){for(var r=n?e:e.parent;null!==r;){if(t(r))return!0;r=r.parent}}(r,(function(t){xi(e,t)})),xi(e,r),Or(r,(function(t){xi(e,t)})),n}function xi(e,t){var n=Nr(t);if(n){for(var r=[],i=[],a=-1,s=0;s<n.length;s++)3===n[s].status||(1===n[s].status?((0,o.assert)(a===s-1,"All SENT items should be at beginning of queue."),a=s,n[s].status=3,n[s].abortReason="set"):((0,o.assert)(0===n[s].status,"Unexpected transaction status in abort"),n[s].unwatcher(),i=i.concat(ir(e.serverSyncTree_,n[s].currentWriteId,!0)),n[s].onComplete&&r.push(n[s].onComplete.bind(null,new Error("set"),!1,null))));-1===a?Rr(t,void 0):n.length=a+1,ni(e.eventQueue_,Mr(t),i);for(s=0;s<r.length;s++)B(r[s])}}var Ni=function(e,t){var n=Ri(e),r=n.namespace;"firebase.com"===n.domain&&E(n.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),r&&"undefined"!==r||"localhost"===n.domain||E("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),n.secure||"undefined"!==typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&S("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().");var i="ws"===n.scheme||"wss"===n.scheme;return{repoInfo:new J(n.host,n.secure,r,t,i,"",r!==n.subdomain),path:new _e(n.pathString)}},Ri=function(e){var t="",n="",r="",i="",o="",s=!0,u="https",l=443;if("string"===typeof e){var c=e.indexOf("//");c>=0&&(u=e.substring(0,c-1),e=e.substring(c+2));var h=e.indexOf("/");-1===h&&(h=e.length);var d=e.indexOf("?");-1===d&&(d=e.length),t=e.substring(0,Math.min(h,d)),h<d&&(i=function(e){for(var t="",n=e.split("/"),r=0;r<n.length;r++)if(n[r].length>0){var i=n[r];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch(o){}t+="/"+i}return t}(e.substring(h,d)));var p=function(e){var t,n,r={};"?"===e.charAt(0)&&(e=e.substring(1));try{for(var i=(0,a.__values)(e.split("&")),o=i.next();!o.done;o=i.next()){var s=o.value;if(0!==s.length){var u=s.split("=");2===u.length?r[decodeURIComponent(u[0])]=decodeURIComponent(u[1]):S("Invalid query segment '"+s+"' in query '"+e+"'")}}}catch(l){t={error:l}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return r}(e.substring(Math.min(e.length,d)));(c=t.indexOf(":"))>=0?(s="https"===u||"wss"===u,l=parseInt(t.substring(c+1),10)):c=t.length;var f=t.slice(0,c);if("localhost"===f.toLowerCase())n="localhost";else if(f.split(".").length<=2)n=f;else{var _=t.indexOf(".");r=t.substring(0,_).toLowerCase(),n=t.substring(_+1),o=r}"ns"in p&&(o=p.ns)}return{host:t,port:l,domain:n,subdomain:r,secure:s,scheme:u,pathString:i,namespace:o}},Ai=function(){function e(e,t,n,r){this.eventType=e,this.eventRegistration=t,this.snapshot=n,this.prevName=r}return e.prototype.getPath=function(){var e=this.snapshot.ref;return"value"===this.eventType?e._path:e.parent._path},e.prototype.getEventType=function(){return this.eventType},e.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},e.prototype.toString=function(){return this.getPath().toString()+":"+this.eventType+":"+(0,o.stringify)(this.snapshot.exportVal())},e}(),Di=function(){function e(e,t,n){this.eventRegistration=e,this.error=t,this.path=n}return e.prototype.getPath=function(){return this.path},e.prototype.getEventType=function(){return"cancel"},e.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},e.prototype.toString=function(){return this.path.toString()+":cancel"},e}(),Oi=function(){function e(e,t){this.snapshotCallback=e,this.cancelCallback=t}return e.prototype.onValue=function(e,t){this.snapshotCallback.call(null,e,t)},e.prototype.onCancel=function(e){return(0,o.assert)(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)},Object.defineProperty(e.prototype,"hasCancelCallback",{get:function(){return!!this.cancelCallback},enumerable:!1,configurable:!0}),e.prototype.matches=function(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context},e}(),Mi=function(){function e(e,t){this._repo=e,this._path=t}return e.prototype.cancel=function(){var e=new o.Deferred;return _i(this._repo,this._path,e.wrapCallback((function(){}))),e.promise},e.prototype.remove=function(){$r("OnDisconnect.remove",this._path);var e=new o.Deferred;return vi(this._repo,this._path,null,e.wrapCallback((function(){}))),e.promise},e.prototype.set=function(e){$r("OnDisconnect.set",this._path),Vr("OnDisconnect.set",e,this._path,!1);var t=new o.Deferred;return vi(this._repo,this._path,e,t.wrapCallback((function(){}))),t.promise},e.prototype.setWithPriority=function(e,t){$r("OnDisconnect.setWithPriority",this._path),Vr("OnDisconnect.setWithPriority",e,this._path,!1),zr("OnDisconnect.setWithPriority",t,!1);var n=new o.Deferred;return function(e,t,n,r,i){var o=lt(n,r);e.server_.onDisconnectPut(t.toString(),o.val(!0),(function(n,r){"ok"===n&&At(e.onDisconnect_,t,o),Ci(0,i,n,r)}))}(this._repo,this._path,e,t,n.wrapCallback((function(){}))),n.promise},e.prototype.update=function(e){$r("OnDisconnect.update",this._path),Hr("OnDisconnect.update",e,this._path,!1);var t=new o.Deferred;return function(e,t,n,r){if((0,o.isEmpty)(n))return T("onDisconnect().update() called with empty data.  Don't do anything."),void Ci(0,r,"ok",void 0);e.server_.onDisconnectMerge(t.toString(),n,(function(i,o){"ok"===i&&q(n,(function(n,r){var i=lt(r);At(e.onDisconnect_,Te(t,n),i)})),Ci(0,r,i,o)}))}(this._repo,this._path,e,t.wrapCallback((function(){}))),t.promise},e}(),qi=function(){function e(e,t,n,r){this._repo=e,this._path=t,this._queryParams=n,this._orderByCalled=r}return Object.defineProperty(e.prototype,"key",{get:function(){return ke(this._path)?null:Ce(this._path)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ref",{get:function(){return new Ui(this._repo,this._path)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_queryIdentifier",{get:function(){var e=Pt(this._queryParams),t=O(e);return"{}"===t?"default":t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_queryObject",{get:function(){return Pt(this._queryParams)},enumerable:!1,configurable:!0}),e.prototype.isEqual=function(t){if(!((t=(0,o.getModularInstance)(t))instanceof e))return!1;var n=this._repo===t._repo,r=Se(this._path,t._path),i=this._queryIdentifier===t._queryIdentifier;return n&&r&&i},e.prototype.toJSON=function(){return this.toString()},e.prototype.toString=function(){return this._repo.toString()+function(e){for(var t="",n=e.pieceNum_;n<e.pieces_.length;n++)""!==e.pieces_[n]&&(t+="/"+encodeURIComponent(String(e.pieces_[n])));return t||"/"}(this._path)},e}();function Fi(e,t){if(!0===e._orderByCalled)throw new Error(t+": You can't combine multiple orderBy calls.")}function Li(e){var t=null,n=null;if(e.hasStart()&&(t=e.getIndexStartValue()),e.hasEnd()&&(n=e.getIndexEndValue()),e.getIndex()===Ue){var r="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(e.hasStart()){if(e.getIndexStartName()!==x)throw new Error(r);if("string"!==typeof t)throw new Error(i)}if(e.hasEnd()){if(e.getIndexEndName()!==N)throw new Error(r);if("string"!==typeof n)throw new Error(i)}}else if(e.getIndex()===tt){if(null!=t&&!Br(t)||null!=n&&!Br(n))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if((0,o.assert)(e.getIndex()instanceof ct||e.getIndex()===ht,"unknown index type."),null!=t&&"object"===typeof t||null!=n&&"object"===typeof n)throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function Wi(e){if(e.hasStart()&&e.hasEnd()&&e.hasLimit()&&!e.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var Ui=function(e){function t(t,n){return e.call(this,t,n,new Tt,!1)||this}return(0,a.__extends)(t,e),Object.defineProperty(t.prototype,"parent",{get:function(){var e=be(this._path);return null===e?null:new t(this._repo,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"root",{get:function(){for(var e=this;null!==e.parent;)e=e.parent;return e},enumerable:!1,configurable:!0}),t}(qi),ji=function(){function e(e,t,n){this._node=e,this.ref=t,this._index=n}return Object.defineProperty(e.prototype,"priority",{get:function(){return this._node.getPriority().val()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"key",{get:function(){return this.ref.key},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._node.numChildren()},enumerable:!1,configurable:!0}),e.prototype.child=function(t){var n=new _e(t),r=Qi(this.ref,t);return new e(this._node.getChild(n),r,tt)},e.prototype.exists=function(){return!this._node.isEmpty()},e.prototype.exportVal=function(){return this._node.val(!0)},e.prototype.forEach=function(t){var n=this;return!this._node.isLeafNode()&&!!this._node.forEachChild(this._index,(function(r,i){return t(new e(i,Qi(n.ref,r),tt))}))},e.prototype.hasChild=function(e){var t=new _e(e);return!this._node.getChild(t).isEmpty()},e.prototype.hasChildren=function(){return!this._node.isLeafNode()&&!this._node.isEmpty()},e.prototype.toJSON=function(){return this.exportVal()},e.prototype.val=function(){return this._node.val()},e}();function Bi(e,t){return(e=(0,o.getModularInstance)(e))._checkNotDeleted("ref"),void 0!==t?Qi(e._root,t):e._root}function Vi(e,t){(e=(0,o.getModularInstance)(e))._checkNotDeleted("refFromURL");var n=Ni(t,e._repo.repoInfo_.nodeAdmin);Jr("refFromURL",n);var r=n.repoInfo;return e._repo.repoInfo_.isCustomHost()||r.host===e._repo.repoInfo_.host||E("refFromURL: Host name does not match the current database: (found "+r.host+" but expected "+e._repo.repoInfo_.host+")"),Bi(e,n.path.toString())}function Qi(e,t){var n,r,i,a;return null===ye((e=(0,o.getModularInstance)(e))._path)?(n="child",r="path",a=!1,(i=t)&&(i=i.replace(/^\/*\.info(\/|$)/,"/")),Gr(n,r,i,a)):Gr("child","path",t,!1),new Ui(e._repo,Te(e._path,t))}function Hi(e,t){e=(0,o.getModularInstance)(e),$r("push",e._path),Vr("push",t,e._path,!0);var n,r=ui(e._repo),i=pt(r),a=Qi(e,i),s=Qi(e,i);return n=null!=t?Yi(s,t).then((function(){return s})):Promise.resolve(s),a.then=n.then.bind(n),a.catch=n.then.bind(n,void 0),a}function zi(e){return $r("remove",e._path),Yi(e,null)}function Yi(e,t){e=(0,o.getModularInstance)(e),$r("set",e._path),Vr("set",t,e._path,!1);var n=new o.Deferred;return fi(e._repo,e._path,t,null,n.wrapCallback((function(){}))),n.promise}function Ki(e,t){e=(0,o.getModularInstance)(e),$r("setPriority",e._path),zr("setPriority",t,!1);var n=new o.Deferred;return fi(e._repo,Te(e._path,".priority"),t,null,n.wrapCallback((function(){}))),n.promise}function Gi(e,t,n){if($r("setWithPriority",e._path),Vr("setWithPriority",t,e._path,!1),zr("setWithPriority",n,!1),".length"===e.key||".keys"===e.key)throw"setWithPriority failed: "+e.key+" is a read-only object.";var r=new o.Deferred;return fi(e._repo,e._path,t,n,r.wrapCallback((function(){}))),r.promise}function $i(e,t){Hr("update",t,e._path,!1);var n=new o.Deferred;return function(e,t,n,r){mi(e,"update",{path:t.toString(),value:n});var i=!0,o=li(e),a={};if(q(n,(function(n,r){i=!1,a[n]=Ir(Te(t,n),lt(r),e.serverSyncTree_,o)})),i)T("update() called with empty data.  Don't do anything."),Ci(0,r,"ok",void 0);else{var s=pi(e),u=rr(e.serverSyncTree_,t,a,s);ei(e.eventQueue_,u),e.server_.merge(t.toString(),n,(function(n,i){var o="ok"===n;o||S("update at "+t+" failed: "+n);var a=ir(e.serverSyncTree_,s,!o),u=a.length>0?Ti(e,t):t;ni(e.eventQueue_,u,a),Ci(0,r,n,i)})),q(n,(function(n){var r=Pi(e,Te(t,n));Ti(e,r)})),ni(e.eventQueue_,t,[])}}(e._repo,e._path,t,n.wrapCallback((function(){}))),n.promise}function Ji(e){return function(e,t){var n=lr(e.serverSyncTree_,t);return null!=n?Promise.resolve(n):e.server_.get(t).then((function(n){var r=lt(n).withIndex(t._queryParams.getIndex()),i=or(e.serverSyncTree_,t._path,r);return ti(e.eventQueue_,t._path,i),Promise.resolve(r)}),(function(n){return mi(e,"get for query "+(0,o.stringify)(t)+" failed: "+n),Promise.reject(new Error(n))}))}((e=(0,o.getModularInstance)(e))._repo,e).then((function(t){return new ji(t,new Ui(e._repo,e._path),e._queryParams.getIndex())}))}var Xi=function(){function e(e){this.callbackContext=e}return e.prototype.respondsTo=function(e){return"value"===e},e.prototype.createEvent=function(e,t){var n=t._queryParams.getIndex();return new Ai("value",this,new ji(e.snapshotNode,new Ui(t._repo,t._path),n))},e.prototype.getEventRunner=function(e){var t=this;return"cancel"===e.getEventType()?function(){return t.callbackContext.onCancel(e.error)}:function(){return t.callbackContext.onValue(e.snapshot,null)}},e.prototype.createCancelEvent=function(e,t){return this.callbackContext.hasCancelCallback?new Di(this,e,t):null},e.prototype.matches=function(t){return t instanceof e&&(!t.callbackContext||!this.callbackContext||t.callbackContext.matches(this.callbackContext))},e.prototype.hasAnyCallback=function(){return null!==this.callbackContext},e}(),Zi=function(){function e(e,t){this.eventType=e,this.callbackContext=t}return e.prototype.respondsTo=function(e){var t="children_added"===e?"child_added":e;return t="children_removed"===t?"child_removed":t,this.eventType===t},e.prototype.createCancelEvent=function(e,t){return this.callbackContext.hasCancelCallback?new Di(this,e,t):null},e.prototype.createEvent=function(e,t){(0,o.assert)(null!=e.childName,"Child events should have a childName.");var n=Qi(new Ui(t._repo,t._path),e.childName),r=t._queryParams.getIndex();return new Ai(e.type,this,new ji(e.snapshotNode,n,r),e.prevName)},e.prototype.getEventRunner=function(e){var t=this;return"cancel"===e.getEventType()?function(){return t.callbackContext.onCancel(e.error)}:function(){return t.callbackContext.onValue(e.snapshot,e.prevName)}},e.prototype.matches=function(t){return t instanceof e&&(this.eventType===t.eventType&&(!this.callbackContext||!t.callbackContext||this.callbackContext.matches(t.callbackContext)))},e.prototype.hasAnyCallback=function(){return!!this.callbackContext},e}();function eo(e,t,n,r,i){var o;if("object"===typeof r&&(o=void 0,i=r),"function"===typeof r&&(o=r),i&&i.onlyOnce){var a=n,s=function(t,n){yi(e._repo,e,l),a(t,n)};s.userCallback=n.userCallback,s.context=n.context,n=s}var u=new Oi(n,o||void 0),l="value"===t?new Xi(u):new Zi(t,u);return function(e,t,n){var r;r=".info"===ye(t._path)?sr(e.infoSyncTree_,t,n):sr(e.serverSyncTree_,t,n),ti(e.eventQueue_,t._path,r)}(e._repo,e,l),function(){return yi(e._repo,e,l)}}function to(e,t,n,r){return eo(e,"value",t,n,r)}function no(e,t,n,r){return eo(e,"child_added",t,n,r)}function ro(e,t,n,r){return eo(e,"child_changed",t,n,r)}function io(e,t,n,r){return eo(e,"child_moved",t,n,r)}function oo(e,t,n,r){return eo(e,"child_removed",t,n,r)}function ao(e,t,n){var r=null,i=n?new Oi(n):null;"value"===t?r=new Xi(i):t&&(r=new Zi(t,i)),yi(e._repo,e,r)}var so=function(){},uo=function(e){function t(t,n){var r=e.call(this)||this;return r._value=t,r._key=n,r}return(0,a.__extends)(t,e),t.prototype._apply=function(e){Vr("endAt",this._value,e._path,!0);var t=It(e._queryParams,this._value,this._key);if(Wi(t),Li(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new qi(e._repo,e._path,t,e._orderByCalled)},t}(so);function lo(e,t){return Kr("endAt","key",t,!0),new uo(e,t)}var co=function(e){function t(t,n){var r=e.call(this)||this;return r._value=t,r._key=n,r}return(0,a.__extends)(t,e),t.prototype._apply=function(e){Vr("endBefore",this._value,e._path,!1);var t=function(e,t,n){var r;return e.index_===Ue?("string"===typeof t&&(t=_t(t)),r=It(e,t,n)):r=It(e,t,null==n?x:_t(n)),r.endBeforeSet_=!0,r}(e._queryParams,this._value,this._key);if(Wi(t),Li(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new qi(e._repo,e._path,t,e._orderByCalled)},t}(so);function ho(e,t){return Kr("endBefore","key",t,!0),new co(e,t)}var po=function(e){function t(t,n){var r=e.call(this)||this;return r._value=t,r._key=n,r}return(0,a.__extends)(t,e),t.prototype._apply=function(e){Vr("startAt",this._value,e._path,!0);var t=kt(e._queryParams,this._value,this._key);if(Wi(t),Li(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new qi(e._repo,e._path,t,e._orderByCalled)},t}(so);function fo(e,t){return void 0===e&&(e=null),Kr("startAt","key",t,!0),new po(e,t)}var _o=function(e){function t(t,n){var r=e.call(this)||this;return r._value=t,r._key=n,r}return(0,a.__extends)(t,e),t.prototype._apply=function(e){Vr("startAfter",this._value,e._path,!1);var t=function(e,t,n){var r;e.index_===Ue?("string"===typeof t&&(t=ft(t)),r=kt(e,t,n)):r=kt(e,t,null==n?N:ft(n));return r.startAfterSet_=!0,r}(e._queryParams,this._value,this._key);if(Wi(t),Li(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new qi(e._repo,e._path,t,e._orderByCalled)},t}(so);function vo(e,t){return Kr("startAfter","key",t,!0),new _o(e,t)}var yo=function(e){function t(t){var n=e.call(this)||this;return n._limit=t,n}return(0,a.__extends)(t,e),t.prototype._apply=function(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new qi(e._repo,e._path,function(e,t){var n=e.copy();return n.limitSet_=!0,n.limit_=t,n.viewFrom_="l",n}(e._queryParams,this._limit),e._orderByCalled)},t}(so);function go(e){if("number"!==typeof e||Math.floor(e)!==e||e<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new yo(e)}var mo=function(e){function t(t){var n=e.call(this)||this;return n._limit=t,n}return(0,a.__extends)(t,e),t.prototype._apply=function(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new qi(e._repo,e._path,function(e,t){var n=e.copy();return n.limitSet_=!0,n.limit_=t,n.viewFrom_="r",n}(e._queryParams,this._limit),e._orderByCalled)},t}(so);function Co(e){if("number"!==typeof e||Math.floor(e)!==e||e<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new mo(e)}var wo=function(e){function t(t){var n=e.call(this)||this;return n._path=t,n}return(0,a.__extends)(t,e),t.prototype._apply=function(e){Fi(e,"orderByChild");var t=new _e(this._path);if(ke(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");var n=new ct(t),r=Et(e._queryParams,n);return Li(r),new qi(e._repo,e._path,r,!0)},t}(so);function bo(e){if("$key"===e)throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if("$priority"===e)throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if("$value"===e)throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return Gr("orderByChild","path",e,!1),new wo(e)}var To=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,a.__extends)(t,e),t.prototype._apply=function(e){Fi(e,"orderByKey");var t=Et(e._queryParams,Ue);return Li(t),new qi(e._repo,e._path,t,!0)},t}(so);function ko(){return new To}var Io=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,a.__extends)(t,e),t.prototype._apply=function(e){Fi(e,"orderByPriority");var t=Et(e._queryParams,tt);return Li(t),new qi(e._repo,e._path,t,!0)},t}(so);function Eo(){return new Io}var So=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,a.__extends)(t,e),t.prototype._apply=function(e){Fi(e,"orderByValue");var t=Et(e._queryParams,ht);return Li(t),new qi(e._repo,e._path,t,!0)},t}(so);function Po(){return new So}var xo=function(e){function t(t,n){var r=e.call(this)||this;return r._value=t,r._key=n,r}return(0,a.__extends)(t,e),t.prototype._apply=function(e){if(Vr("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new uo(this._value,this._key)._apply(new po(this._value,this._key)._apply(e))},t}(so);function No(e,t){return Kr("equalTo","key",t,!0),new xo(e,t)}function Ro(e){for(var t,n,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];var s=(0,o.getModularInstance)(e);try{for(var u=(0,a.__values)(r),l=u.next();!l.done;l=u.next()){var c=l.value;s=c._apply(s)}}catch(h){t={error:h}}finally{try{l&&!l.done&&(n=u.return)&&n.call(u)}finally{if(t)throw t.error}}return s}!function(e){(0,o.assert)(!Mn,"__referenceConstructor has already been defined"),Mn=e}(Ui),function(e){(0,o.assert)(!Bn,"__referenceConstructor has already been defined"),Bn=e}(Ui);var Ao={},Do=!1;function Oo(e,t,n,r,i){var o=r||e.options.databaseURL;void 0===o&&(e.options.projectId||E("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),T("Using default host for project ",e.options.projectId),o=e.options.projectId+"-default-rtdb.firebaseio.com");var a,s=Ni(o,i),l=s.repoInfo,c=void 0;"undefined"!==typeof u&&(c=u.env.FIREBASE_DATABASE_EMULATOR_HOST),c?(a=!0,o="http://"+c+"?ns="+l.namespace,l=(s=Ni(o,i)).repoInfo):a=!s.repoInfo.secure;var h=i&&a?new z(z.OWNER):new H(e.name,e.options,t);Jr("Invalid Firebase Database URL",s),ke(s.path)||E("Database URL must point to the root of a Firebase Database (not including a child path).");var d=function(e,t,n,r){var i=Ao[t.name];i||(i={},Ao[t.name]=i);var o=i[e.toURLString()];o&&E("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call.");return o=new ai(e,Do,n,r),i[e.toURLString()]=o,o}(l,e,h,new Q(e.name,n));return new Mo(d,e)}var Mo=function(){function e(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}return Object.defineProperty(e.prototype,"_repo",{get:function(){return this._instanceStarted||(si(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_root",{get:function(){return this._rootInternal||(this._rootInternal=new Ui(this._repo,ve())),this._rootInternal},enumerable:!1,configurable:!0}),e.prototype._delete=function(){return null!==this._rootInternal&&(!function(e,t){var n=Ao[t];n&&n[e.key]===e||E("Database "+t+"("+e.repoInfo_+") has already been deleted."),gi(e),delete n[e.key]}(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()},e.prototype._checkNotDeleted=function(e){null===this._rootInternal&&E("Cannot call "+e+" on a deleted database.")},e}();function qo(e,t,n,r){void 0===r&&(r={}),(e=(0,o.getModularInstance)(e))._checkNotDeleted("useEmulator"),e._instanceStarted&&E("Cannot call useEmulator() after instance has already been initialized.");var i=e._repoInternal,a=void 0;if(i.repoInfo_.nodeAdmin)r.mockUserToken&&E('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),a=new z(z.OWNER);else if(r.mockUserToken){var s=(0,o.createMockUserToken)(r.mockUserToken,e.app.options.projectId);a=new z(s)}!function(e,t,n,r){e.repoInfo_=new J(t+":"+n,!1,e.repoInfo_.namespace,e.repoInfo_.webSocketOnly,e.repoInfo_.nodeAdmin,e.repoInfo_.persistenceKey,e.repoInfo_.includeNamespaceInQueryParams),r&&(e.authTokenProvider_=r)}(i,t,n,a)}function Fo(e){(e=(0,o.getModularInstance)(e))._checkNotDeleted("goOffline"),gi(e._repo)}function Lo(e){var t;(e=(0,o.getModularInstance)(e))._checkNotDeleted("goOnline"),(t=e._repo).persistentConnection_&&t.persistentConnection_.resume(oi)}var Wo={".sv":"timestamp"};var Uo=function(){function e(e,t){this.committed=e,this.snapshot=t}return e.prototype.toJSON=function(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}},e}();function jo(e,t,n){var r;if(e=(0,o.getModularInstance)(e),$r("Reference.transaction",e._path),".length"===e.key||".keys"===e.key)throw"Reference.transaction failed: "+e.key+" is a read-only object.";var i=null===(r=null===n||void 0===n?void 0:n.applyLocally)||void 0===r||r,a=new o.Deferred,s=to(e,(function(){}));return function(e,t,n,r,i,a){mi(e,"transaction on "+t);var s={path:t,update:n,onComplete:r,status:null,order:y(),applyLocally:a,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},u=wi(e,t,void 0);s.currentInputSnapshot=u;var l=s.update(u.val());if(void 0===l)s.unwatcher(),s.currentOutputSnapshotRaw=null,s.currentOutputSnapshotResolved=null,s.onComplete&&s.onComplete(null,!1,s.currentInputSnapshot);else{Qr("transaction failed: Data returned ",l,s.path),s.status=0;var c=xr(e.transactionQueueTree_,t),h=Nr(c)||[];h.push(s),Rr(c,h);var d=void 0;"object"===typeof l&&null!==l&&(0,o.contains)(l,".priority")?(d=(0,o.safeGet)(l,".priority"),(0,o.assert)(Br(d),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):d=(ur(e.serverSyncTree_,t)||st.EMPTY_NODE).getPriority().val();var p=li(e),f=lt(l,d),_=Er(f,u,p);s.currentOutputSnapshotRaw=f,s.currentOutputSnapshotResolved=_,s.currentWriteId=pi(e);var v=nr(e.serverSyncTree_,t,_,s.currentWriteId,s.applyLocally);ni(e.eventQueue_,t,v),bi(e,e.transactionQueueTree_)}}(e._repo,e._path,t,(function(t,n,r){var i=null;t?a.reject(t):(i=new ji(r,new Ui(e._repo,e._path),tt),a.resolve(new Uo(n,i)))}),s,i),a.promise}var Bo=function(){function e(e){this._delegate=e}return e.prototype.cancel=function(e){(0,o.validateArgCount)("OnDisconnect.cancel",0,1,arguments.length),(0,o.validateCallback)("OnDisconnect.cancel","onComplete",e,!0);var t=this._delegate.cancel();return e&&t.then((function(){return e(null)}),(function(t){return e(t)})),t},e.prototype.remove=function(e){(0,o.validateArgCount)("OnDisconnect.remove",0,1,arguments.length),(0,o.validateCallback)("OnDisconnect.remove","onComplete",e,!0);var t=this._delegate.remove();return e&&t.then((function(){return e(null)}),(function(t){return e(t)})),t},e.prototype.set=function(e,t){(0,o.validateArgCount)("OnDisconnect.set",1,2,arguments.length),(0,o.validateCallback)("OnDisconnect.set","onComplete",t,!0);var n=this._delegate.set(e);return t&&n.then((function(){return t(null)}),(function(e){return t(e)})),n},e.prototype.setWithPriority=function(e,t,n){(0,o.validateArgCount)("OnDisconnect.setWithPriority",2,3,arguments.length),(0,o.validateCallback)("OnDisconnect.setWithPriority","onComplete",n,!0);var r=this._delegate.setWithPriority(e,t);return n&&r.then((function(){return n(null)}),(function(e){return n(e)})),r},e.prototype.update=function(e,t){if((0,o.validateArgCount)("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){for(var n={},r=0;r<e.length;++r)n[""+r]=e[r];e=n,S("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}(0,o.validateCallback)("OnDisconnect.update","onComplete",t,!0);var i=this._delegate.update(e);return t&&i.then((function(){return t(null)}),(function(e){return t(e)})),i},e}(),Vo=function(){function e(e,t){this.committed=e,this.snapshot=t}return e.prototype.toJSON=function(){return(0,o.validateArgCount)("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}},e}(),Qo=function(){function e(e,t){this._database=e,this._delegate=t}return e.prototype.val=function(){return(0,o.validateArgCount)("DataSnapshot.val",0,0,arguments.length),this._delegate.val()},e.prototype.exportVal=function(){return(0,o.validateArgCount)("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()},e.prototype.toJSON=function(){return(0,o.validateArgCount)("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()},e.prototype.exists=function(){return(0,o.validateArgCount)("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()},e.prototype.child=function(t){return(0,o.validateArgCount)("DataSnapshot.child",0,1,arguments.length),t=String(t),Gr("DataSnapshot.child","path",t,!1),new e(this._database,this._delegate.child(t))},e.prototype.hasChild=function(e){return(0,o.validateArgCount)("DataSnapshot.hasChild",1,1,arguments.length),Gr("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)},e.prototype.getPriority=function(){return(0,o.validateArgCount)("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority},e.prototype.forEach=function(t){var n=this;return(0,o.validateArgCount)("DataSnapshot.forEach",1,1,arguments.length),(0,o.validateCallback)("DataSnapshot.forEach","action",t,!1),this._delegate.forEach((function(r){return t(new e(n._database,r))}))},e.prototype.hasChildren=function(){return(0,o.validateArgCount)("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()},Object.defineProperty(e.prototype,"key",{get:function(){return this._delegate.key},enumerable:!1,configurable:!0}),e.prototype.numChildren=function(){return(0,o.validateArgCount)("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size},e.prototype.getRef=function(){return(0,o.validateArgCount)("DataSnapshot.ref",0,0,arguments.length),new zo(this._database,this._delegate.ref)},Object.defineProperty(e.prototype,"ref",{get:function(){return this.getRef()},enumerable:!1,configurable:!0}),e}(),Ho=function(){function e(e,t){this.database=e,this._delegate=t}return e.prototype.on=function(t,n,r,i){var a,s=this;(0,o.validateArgCount)("Query.on",2,4,arguments.length),(0,o.validateCallback)("Query.on","callback",n,!1);var u=e.getCancelAndContextArgs_("Query.on",r,i),l=function(e,t){n.call(u.context,new Qo(s.database,e),t)};l.userCallback=n,l.context=u.context;var c=null===(a=u.cancel)||void 0===a?void 0:a.bind(u.context);switch(t){case"value":return to(this._delegate,l,c),n;case"child_added":return no(this._delegate,l,c),n;case"child_removed":return oo(this._delegate,l,c),n;case"child_changed":return ro(this._delegate,l,c),n;case"child_moved":return io(this._delegate,l,c),n;default:throw new Error((0,o.errorPrefix)("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}},e.prototype.off=function(e,t,n){if((0,o.validateArgCount)("Query.off",0,3,arguments.length),Yr("Query.off",e,!0),(0,o.validateCallback)("Query.off","callback",t,!0),(0,o.validateContextObject)("Query.off","context",n,!0),t){var r=function(){};r.userCallback=t,r.context=n,ao(this._delegate,e,r)}else ao(this._delegate,e)},e.prototype.get=function(){var e=this;return Ji(this._delegate).then((function(t){return new Qo(e.database,t)}))},e.prototype.once=function(t,n,r,i){var a=this;(0,o.validateArgCount)("Query.once",1,4,arguments.length),(0,o.validateCallback)("Query.once","callback",n,!0);var s=e.getCancelAndContextArgs_("Query.once",r,i),u=new o.Deferred,l=function(e,t){var r=new Qo(a.database,e);n&&n.call(s.context,r,t),u.resolve(r)};l.userCallback=n,l.context=s.context;var c=function(e){s.cancel&&s.cancel.call(s.context,e),u.reject(e)};switch(t){case"value":to(this._delegate,l,c,{onlyOnce:!0});break;case"child_added":no(this._delegate,l,c,{onlyOnce:!0});break;case"child_removed":oo(this._delegate,l,c,{onlyOnce:!0});break;case"child_changed":ro(this._delegate,l,c,{onlyOnce:!0});break;case"child_moved":io(this._delegate,l,c,{onlyOnce:!0});break;default:throw new Error((0,o.errorPrefix)("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return u.promise},e.prototype.limitToFirst=function(t){return(0,o.validateArgCount)("Query.limitToFirst",1,1,arguments.length),new e(this.database,Ro(this._delegate,go(t)))},e.prototype.limitToLast=function(t){return(0,o.validateArgCount)("Query.limitToLast",1,1,arguments.length),new e(this.database,Ro(this._delegate,Co(t)))},e.prototype.orderByChild=function(t){return(0,o.validateArgCount)("Query.orderByChild",1,1,arguments.length),new e(this.database,Ro(this._delegate,bo(t)))},e.prototype.orderByKey=function(){return(0,o.validateArgCount)("Query.orderByKey",0,0,arguments.length),new e(this.database,Ro(this._delegate,ko()))},e.prototype.orderByPriority=function(){return(0,o.validateArgCount)("Query.orderByPriority",0,0,arguments.length),new e(this.database,Ro(this._delegate,Eo()))},e.prototype.orderByValue=function(){return(0,o.validateArgCount)("Query.orderByValue",0,0,arguments.length),new e(this.database,Ro(this._delegate,Po()))},e.prototype.startAt=function(t,n){return void 0===t&&(t=null),(0,o.validateArgCount)("Query.startAt",0,2,arguments.length),new e(this.database,Ro(this._delegate,fo(t,n)))},e.prototype.startAfter=function(t,n){return void 0===t&&(t=null),(0,o.validateArgCount)("Query.startAfter",0,2,arguments.length),new e(this.database,Ro(this._delegate,vo(t,n)))},e.prototype.endAt=function(t,n){return void 0===t&&(t=null),(0,o.validateArgCount)("Query.endAt",0,2,arguments.length),new e(this.database,Ro(this._delegate,lo(t,n)))},e.prototype.endBefore=function(t,n){return void 0===t&&(t=null),(0,o.validateArgCount)("Query.endBefore",0,2,arguments.length),new e(this.database,Ro(this._delegate,ho(t,n)))},e.prototype.equalTo=function(t,n){return(0,o.validateArgCount)("Query.equalTo",1,2,arguments.length),new e(this.database,Ro(this._delegate,No(t,n)))},e.prototype.toString=function(){return(0,o.validateArgCount)("Query.toString",0,0,arguments.length),this._delegate.toString()},e.prototype.toJSON=function(){return(0,o.validateArgCount)("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()},e.prototype.isEqual=function(t){if((0,o.validateArgCount)("Query.isEqual",1,1,arguments.length),!(t instanceof e)){var n="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(n)}return this._delegate.isEqual(t._delegate)},e.getCancelAndContextArgs_=function(e,t,n){var r={cancel:void 0,context:void 0};if(t&&n)r.cancel=t,(0,o.validateCallback)(e,"cancel",r.cancel,!0),r.context=n,(0,o.validateContextObject)(e,"context",r.context,!0);else if(t)if("object"===typeof t&&null!==t)r.context=t;else{if("function"!==typeof t)throw new Error((0,o.errorPrefix)(e,"cancelOrContext")+" must either be a cancel callback or a context object.");r.cancel=t}return r},Object.defineProperty(e.prototype,"ref",{get:function(){return new zo(this.database,new Ui(this._delegate._repo,this._delegate._path))},enumerable:!1,configurable:!0}),e}(),zo=function(e){function t(t,n){var r=e.call(this,t,new qi(n._repo,n._path,new Tt,!1))||this;return r.database=t,r._delegate=n,r}return(0,a.__extends)(t,e),t.prototype.getKey=function(){return(0,o.validateArgCount)("Reference.key",0,0,arguments.length),this._delegate.key},t.prototype.child=function(e){return(0,o.validateArgCount)("Reference.child",1,1,arguments.length),"number"===typeof e&&(e=String(e)),new t(this.database,Qi(this._delegate,e))},t.prototype.getParent=function(){(0,o.validateArgCount)("Reference.parent",0,0,arguments.length);var e=this._delegate.parent;return e?new t(this.database,e):null},t.prototype.getRoot=function(){return(0,o.validateArgCount)("Reference.root",0,0,arguments.length),new t(this.database,this._delegate.root)},t.prototype.set=function(e,t){(0,o.validateArgCount)("Reference.set",1,2,arguments.length),(0,o.validateCallback)("Reference.set","onComplete",t,!0);var n=Yi(this._delegate,e);return t&&n.then((function(){return t(null)}),(function(e){return t(e)})),n},t.prototype.update=function(e,t){if((0,o.validateArgCount)("Reference.update",1,2,arguments.length),Array.isArray(e)){for(var n={},r=0;r<e.length;++r)n[""+r]=e[r];e=n,S("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}$r("Reference.update",this._delegate._path),(0,o.validateCallback)("Reference.update","onComplete",t,!0);var i=$i(this._delegate,e);return t&&i.then((function(){return t(null)}),(function(e){return t(e)})),i},t.prototype.setWithPriority=function(e,t,n){(0,o.validateArgCount)("Reference.setWithPriority",2,3,arguments.length),(0,o.validateCallback)("Reference.setWithPriority","onComplete",n,!0);var r=Gi(this._delegate,e,t);return n&&r.then((function(){return n(null)}),(function(e){return n(e)})),r},t.prototype.remove=function(e){(0,o.validateArgCount)("Reference.remove",0,1,arguments.length),(0,o.validateCallback)("Reference.remove","onComplete",e,!0);var t=zi(this._delegate);return e&&t.then((function(){return e(null)}),(function(t){return e(t)})),t},t.prototype.transaction=function(e,t,n){var r=this;(0,o.validateArgCount)("Reference.transaction",1,3,arguments.length),(0,o.validateCallback)("Reference.transaction","transactionUpdate",e,!1),(0,o.validateCallback)("Reference.transaction","onComplete",t,!0),Xr("Reference.transaction","applyLocally",n,!0);var i=jo(this._delegate,e,{applyLocally:n}).then((function(e){return new Vo(e.committed,new Qo(r.database,e.snapshot))}));return t&&i.then((function(e){return t(null,e.committed,e.snapshot)}),(function(e){return t(e,!1,null)})),i},t.prototype.setPriority=function(e,t){(0,o.validateArgCount)("Reference.setPriority",1,2,arguments.length),(0,o.validateCallback)("Reference.setPriority","onComplete",t,!0);var n=Ki(this._delegate,e);return t&&n.then((function(){return t(null)}),(function(e){return t(e)})),n},t.prototype.push=function(e,n){var r=this;(0,o.validateArgCount)("Reference.push",0,2,arguments.length),(0,o.validateCallback)("Reference.push","onComplete",n,!0);var i=Hi(this._delegate,e),a=i.then((function(e){return new t(r.database,e)}));n&&a.then((function(){return n(null)}),(function(e){return n(e)}));var s=new t(this.database,i);return s.then=a.then.bind(a),s.catch=a.catch.bind(a,void 0),s},t.prototype.onDisconnect=function(){return $r("Reference.onDisconnect",this._delegate._path),new Bo(new Mi(this._delegate._repo,this._delegate._path))},Object.defineProperty(t.prototype,"key",{get:function(){return this.getKey()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this.getParent()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"root",{get:function(){return this.getRoot()},enumerable:!1,configurable:!0}),t}(Ho),Yo=function(){function e(e,t){var n=this;this._delegate=e,this.app=t,this.INTERNAL={delete:function(){return n._delegate._delete()}}}return e.prototype.useEmulator=function(e,t,n){void 0===n&&(n={}),qo(this._delegate,e,t,n)},e.prototype.ref=function(e){if((0,o.validateArgCount)("database.ref",0,1,arguments.length),e instanceof zo){var t=Vi(this._delegate,e.toString());return new zo(this,t)}t=Bi(this._delegate,e);return new zo(this,t)},e.prototype.refFromURL=function(e){var t="database.refFromURL";(0,o.validateArgCount)(t,1,1,arguments.length);var n=Vi(this._delegate,e);return new zo(this,n)},e.prototype.goOffline=function(){return(0,o.validateArgCount)("database.goOffline",0,0,arguments.length),Fo(this._delegate)},e.prototype.goOnline=function(){return(0,o.validateArgCount)("database.goOnline",0,0,arguments.length),Lo(this._delegate)},e.ServerValue={TIMESTAMP:Wo,increment:function(e){return function(e){return{".sv":{increment:e}}}(e)}},e}();var Ko=Object.freeze({__proto__:null,forceLongPolling:function(){le.forceDisallow(),ae.forceAllow()},forceWebSockets:function(){ae.forceDisallow()},isWebSocketsAvailable:function(){return le.isAvailable()},setSecurityDebugCallback:function(e,t){e._delegate._repo.persistentConnection_.securityDebugCallback_=t},stats:function(e,t){!function(e,t){if(void 0===t&&(t=!1),"undefined"!==typeof console){var n;t?(e.statsListener_||(e.statsListener_=new qt(e.stats_)),n=e.statsListener_.get()):n=e.stats_.get();var r=Object.keys(n).reduce((function(e,t){return Math.max(t.length,e)}),0);q(n,(function(e,t){for(var n=e,i=e.length;i<r+2;i++)n+=" ";console.log(n+t)}))}}(e._delegate._repo,t)},statsIncrementCounter:function(e,t){!function(e,t){var n,r;e.stats_.incrementCounter(t),n=e.statsReporter_,r=t,n.statsToReport_[r]=!0}(e._delegate._repo,t)},dataUpdateCount:function(e){return e._delegate._repo.dataUpdateCount},interceptServerData:function(e,t){return function(e,t){e.interceptServerDataCallback_=t}(e._delegate._repo,t)},initStandalone:function(e){var t=e.app,n=e.url,r=e.version,o=e.customAuthImpl,a=e.namespace,s=e.nodeAdmin,u=void 0!==s&&s;c(r);var l=new i.Provider("auth-internal",new i.ComponentContainer("database-standalone"));return l.setComponent(new i.Component("auth-internal",(function(){return o}),"PRIVATE")),{instance:new Yo(Oo(t,l,void 0,n,u),t),namespace:a}}}),Go=qe;qe.prototype.simpleListen=function(e,t){this.sendRequest("q",{p:e},t)},qe.prototype.echo=function(e,t){this.sendRequest("echo",{d:e},t)};var $o=he,Jo=J,Xo=Object.freeze({__proto__:null,DataConnection:Go,RealTimeConnection:$o,hijackHash:function(e){var t=qe.prototype.put;return qe.prototype.put=function(n,r,i,o){void 0!==o&&(o=e()),t.call(this,n,r,i,o)},function(){qe.prototype.put=t}},ConnectionTarget:Jo,queryIdentifier:function(e){return e._delegate._queryIdentifier},forceRestClient:function(e){!function(e){Do=e}(e)}}),Zo=Yo.ServerValue;!function(t){c(t.SDK_VERSION);var n=t.INTERNAL.registerComponent(new i.Component("database",(function(e,t){var n=t.instanceIdentifier,r=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),o=e.getProvider("app-check-internal");return new Yo(Oo(r,i,o,n),r)}),"PUBLIC").setServiceProps({Reference:zo,Query:Ho,Database:Yo,DataSnapshot:Qo,enableLogging:b,INTERNAL:Ko,ServerValue:Zo,TEST_ACCESS:Xo}).setMultipleInstances(!0));t.registerVersion("@firebase/database","0.10.9"),(0,o.isNodeSdk)()&&(e.exports=n)}(r.default)}}]);